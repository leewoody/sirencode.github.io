<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>Xposed [ Diablo ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/iLiKE.css">
    
  
  
  
  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
    <script id="leancloud">
      AV.init({
          appId: "6E5zTbTljdUbVW2WkXPsXGJk-gzGzoHsz",
          appKey: "0vsyDKfNpeSECAI70J794ugv"
      });
    </script>

</head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="/home.png"></img>
        </a>
      </div>
      <div class="menu-right">
        
          
          
          
          
          
          
          <a href="/">Home</a>
        
          
          
          
          
          
          
          <a href="/archives">Archives</a>
        
      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">Xposed</h1>
<article class="post markdown-style">
  <h1 id="Xposed"><a href="#Xposed" class="headerlink" title="Xposed"></a>Xposed</h1><p><a href="https://github.com/rovo89">Xposed</a>诞生于著名的XDA论坛，是由rovo89的一位严禁的德国小哥设计的一个针对Android平台的动态劫持项目。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>首先需要相对root环境，注意这里说的是相对，因为virtualxposed的出现，在主机非root的情况下也可以实现部分xposed的功能，具体实现后续介绍virtualxposed详细说明。</p>
<h2 id="核心模块介绍"><a href="#核心模块介绍" class="headerlink" title="核心模块介绍"></a>核心模块介绍</h2><ul>
<li>Xposed: Xposed的C++部分，主要是用来替换/system/bin/app_process，并为 XposedBridge提供JNI方法。</li>
<li>XposedBridge: Xposed的Java部分，以XposedBridge.jar文件存在，负责在Native 层与FrameWork层进行交互。/system/bin/app_process进程启动过程中会加载该jar包，其它的Modules的开发与运行都是基于这个jar。</li>
<li>XposedInstaller: Xposed的安装包，负责配置Xposed工作的环境并且提供对基于Xposed框架的Modules的管理。在安装XposedInstaller之后，app_process与XposedBridge.jar放置在了/data/data/de.robv.android.xposed.installer。</li>
</ul>
<h2 id="Hook原理"><a href="#Hook原理" class="headerlink" title="Hook原理"></a>Hook原理</h2><p>由于处于Linux 用户态，每个进程都有自己独立的进程空间，所以必须先注入到所要Hook 的进程空间，修改其内存中的进程代码，替换其过程表的符号地址。在Android 中一般是通过ptrace函数附加进程，然后向远程进程注人so 库，从而达到监控以及远程进程关键函数挂钩。</p>
<h3 id="ptrace-函数"><a href="#ptrace-函数" class="headerlink" title="ptrace 函数"></a>ptrace 函数</h3><p>为方便应用软件的开发和调试，从 Unix 的早期版本开始就提供了一种对运行中的进程进行跟踪和控制的手段，那就是系统调用 ptrace()。通过 ptrace()，一个进程可以动态地读/写另一个进程的内存和寄存器，包括其指令空间、数据空间、堆栈以及所有的寄存器。与信号机制（以及其它手段）相结合， 就可以实现让一个进程在另一个进程的控制和跟踪下运行的目的。ptrace 提供了一种使父进程得以监视和控制其他进程的方式，它还能够改变子进程巾的寄存器和内核映像，因而可以实现断点调试和系统调用的跟踪。</p>
<p>ptrace从名字上看是用于进程跟踪的，它提供了父进程可以观察和控制其子进程执行的能力，并允许父进程检查和替换子进程的内核镜像(包括寄存器)的值。其基本原理是: 当使用了ptrace跟踪后，所有发送给被跟踪的子进程的信号(除了SIGKILL)，都会被转发给父进程，而子进程则会被阻塞，这时子进程的状态就会被系统标注为TASK_TRACED。而父进程收到信号后，就可以对停止下来的子进程进行检查和修改，然后让子进程继续运行。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>Xposed框架是一款可以在不修改APK的情况下影响程序运行（修改系统）的框架服务，通过替换/system/bin/app_process 程序控制 zygote 进程，使 app_process 在启动过程中加载XposedBridge.jar 这个jar包，从而完成对Zygote进程及其创建的Dalvik虚拟机的劫持。</p>
<p>在Android 系统中，应用程序进程都是由Zygote 进程孵化出来的，而Zygote 进程是由init 进程启动的。Zygote 进程在启动时会创建一个Dalvik 虚拟机实例，每当它孵化一个新的应用程序进程时，都会将这个Dalvik 虚拟机实例复制到新的应用程序进程里面去从而使每一个应用程序进程都有一个独立的Dalvik 虚拟机实例。所以如果选择对Zygote 进程Hook ，则能够达到针对系统上所有的应用程序进程Hook ，即一个全局Hook。而对应的app_process正是zygote进程启动一个应用程序的入口，常见的Hook 框架Xposed与Cydiasubstrate 也是通过替换app_process来完成全局Hook的。</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><h3 id="1-替换系统的-system-bin-app-process"><a href="#1-替换系统的-system-bin-app-process" class="headerlink" title="1 替换系统的/system/bin/app_process"></a>1 替换系统的/system/bin/app_process</h3><p>首先查看下app_process的源码，源码位置/frameworks/base/cmds/app_process/app_main.cpp</p>
<p>9.0 app_process/app_main.cpp的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"appproc"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/IPCThreadState.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hwbinder/IPCThreadState.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/properties.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/trace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android_runtime/AndroidRuntime.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;private/android_filesystem_config.h&gt;  // for AID_SYSTEM</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">app_usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">        <span class="string">"Usage: app_process [java-options] cmd-dir start-class-name [options]\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRuntime</span> :</span> <span class="keyword">public</span> AndroidRuntime</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    AppRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength)</span><br><span class="line">        : AndroidRuntime(argBlockStart, argBlockLength)</span><br><span class="line">        , mClass(<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setClassNameAndArgs</span><span class="params">(<span class="keyword">const</span> String8&amp; className, <span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> *argv)</span> </span>&#123;</span><br><span class="line">        mClassName = className;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argc; ++i) &#123;</span><br><span class="line">             mArgs.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onVmCreated</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClassName.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// Zygote. Nothing to do here.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This is a little awkward because the JNI FindClass call uses the</span></span><br><span class="line"><span class="comment">         * class loader associated with the native method we're executing in.</span></span><br><span class="line"><span class="comment">         * If called in onStarted (from RuntimeInit.finishInit because we're</span></span><br><span class="line"><span class="comment">         * launching "am", for example), FindClass would see that we're calling</span></span><br><span class="line"><span class="comment">         * from a boot class' native method, and so wouldn't look for the class</span></span><br><span class="line"><span class="comment">         * we're trying to look up in CLASSPATH. Unfortunately it needs to,</span></span><br><span class="line"><span class="comment">         * because the "am" classes are not boot classes.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The easiest fix is to call FindClass here, early on before we start</span></span><br><span class="line"><span class="comment">         * executing boot class Java code and thereby deny ourselves access to</span></span><br><span class="line"><span class="comment">         * non-boot classes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">char</span>* slashClassName = toSlashClassName(mClassName.<span class="built_in">string</span>());</span><br><span class="line">        mClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">        <span class="keyword">if</span> (mClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"ERROR: could not find class '%s'\n"</span>, mClassName.<span class="built_in">string</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">        mClass = <span class="keyword">reinterpret_cast</span>&lt;jclass&gt;(env-&gt;NewGlobalRef(mClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">        AndroidRuntime* ar = AndroidRuntime::getRuntime();</span><br><span class="line">        ar-&gt;callMain(mClassName, mClass, mArgs);</span><br><span class="line"></span><br><span class="line">        IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">        hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onExit</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClassName.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// if zygote</span></span><br><span class="line">            IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">            hardware::IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AndroidRuntime::onExit(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String8 mClassName;</span><br><span class="line">    Vector&lt;String8&gt; mArgs;</span><br><span class="line">    jclass mClass;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> size_t <span class="title">computeArgBlockSize</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> This assumes that all arguments are allocated in</span></span><br><span class="line">    <span class="comment">// contiguous memory. There isn't any documented guarantee</span></span><br><span class="line">    <span class="comment">// that this is the case, but this is how the kernel does it</span></span><br><span class="line">    <span class="comment">// (see fs/exec.c).</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Also note that this is a constant for "normal" android apps.</span></span><br><span class="line">    <span class="comment">// Since they're forked from zygote, the size of their command line</span></span><br><span class="line">    <span class="comment">// is the size of the zygote command line.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We change the process name of the process by over-writing</span></span><br><span class="line">    <span class="comment">// the start of the argument block (argv[0]) with the new name of</span></span><br><span class="line">    <span class="comment">// the process, so we'd mysteriously start getting truncated process</span></span><br><span class="line">    <span class="comment">// names if the zygote command line decreases in size.</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> start = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">uintptr_t</span> end = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(argv[argc - <span class="number">1</span>]);</span><br><span class="line">    end += <span class="built_in">strlen</span>(argv[argc - <span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (end - start);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">maybeCreateDalvikCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__aarch64__)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> kInstructionSet[] = <span class="string">"arm64"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__x86_64__)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> kInstructionSet[] = <span class="string">"x86_64"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__arm__)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> kInstructionSet[] = <span class="string">"arm"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__i386__)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> kInstructionSet[] = <span class="string">"x86"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (__mips__) &amp;&amp; !defined(__LP64__)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> kInstructionSet[] = <span class="string">"mips"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (__mips__) &amp;&amp; defined(__LP64__)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> kInstructionSet[] = <span class="string">"mips64"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">"Unknown instruction set"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* androidRoot = getenv(<span class="string">"ANDROID_DATA"</span>);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(androidRoot == <span class="literal">NULL</span>, <span class="string">"ANDROID_DATA environment variable unset"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> dalvikCacheDir[PATH_MAX];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> numChars = <span class="built_in">snprintf</span>(dalvikCacheDir, PATH_MAX,</span><br><span class="line">            <span class="string">"%s/dalvik-cache/%s"</span>, androidRoot, kInstructionSet);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF((numChars &gt;= PATH_MAX || numChars &lt; <span class="number">0</span>),</span><br><span class="line">            <span class="string">"Error constructing dalvik cache : %s"</span>, strerror(errno));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> result = mkdir(dalvikCacheDir, <span class="number">0711</span>);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF((result &lt; <span class="number">0</span> &amp;&amp; errno != EEXIST),</span><br><span class="line">            <span class="string">"Error creating cache dir %s : %s"</span>, dalvikCacheDir, strerror(errno));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We always perform these steps because the directory might</span></span><br><span class="line">    <span class="comment">// already exist, with wider permissions and a different owner</span></span><br><span class="line">    <span class="comment">// than we'd like.</span></span><br><span class="line">    result = chown(dalvikCacheDir, AID_ROOT, AID_ROOT);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF((result &lt; <span class="number">0</span>), <span class="string">"Error changing dalvik-cache ownership : %s"</span>, strerror(errno));</span><br><span class="line"></span><br><span class="line">    result = chmod(dalvikCacheDir, <span class="number">0711</span>);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF((result &lt; <span class="number">0</span>),</span><br><span class="line">            <span class="string">"Error changing dalvik-cache permissions : %s"</span>, strerror(errno));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP64__)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> ABI_LIST_PROPERTY[] = <span class="string">"ro.product.cpu.abilist64"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> ZYGOTE_NICE_NAME[] = <span class="string">"zygote64"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> ABI_LIST_PROPERTY[] = <span class="string">"ro.product.cpu.abilist32"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> ZYGOTE_NICE_NAME[] = <span class="string">"zygote"</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!LOG_NDEBUG) &#123;</span><br><span class="line">      String8 argv_String;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argc; ++i) &#123;</span><br><span class="line">        argv_String.append(<span class="string">"\""</span>);</span><br><span class="line">        argv_String.append(argv[i]);</span><br><span class="line">        argv_String.append(<span class="string">"\" "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      ALOGV(<span class="string">"app_process main with argv: %s"</span>, argv_String.<span class="built_in">string</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</span><br><span class="line">    <span class="comment">// Process command line arguments</span></span><br><span class="line">    <span class="comment">// ignore argv[0]</span></span><br><span class="line">    argc--;</span><br><span class="line">    argv++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Everything up to '--' or first non '-' arg goes to the vm.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The first argument after the VM args is the "parent dir", which</span></span><br><span class="line">    <span class="comment">// is currently unused.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// After the parent dir, we expect one or more the following internal</span></span><br><span class="line">    <span class="comment">// arguments :</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// --zygote : Start in zygote mode</span></span><br><span class="line">    <span class="comment">// --start-system-server : Start the system server.</span></span><br><span class="line">    <span class="comment">// --application : Start in application (stand alone, non zygote) mode.</span></span><br><span class="line">    <span class="comment">// --nice-name : The nice name for this process.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// For non zygote starts, these arguments will be followed by</span></span><br><span class="line">    <span class="comment">// the main class name. All remaining arguments are passed to</span></span><br><span class="line">    <span class="comment">// the main method of this class.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// For zygote starts, all remaining arguments are passed to the zygote.</span></span><br><span class="line">    <span class="comment">// main function.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Note that we must copy argument string values since we will rewrite the</span></span><br><span class="line">    <span class="comment">// entire argument block when we apply the nice name to argv0.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// As an exception to the above rule, anything in "spaced commands"</span></span><br><span class="line">    <span class="comment">// goes to the vm even though it has a space in it.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* spaced_commands[] = &#123; <span class="string">"-cp"</span>, <span class="string">"-classpath"</span> &#125;;</span><br><span class="line">    <span class="comment">// Allow "spaced commands" to be succeeded by exactly 1 argument (regardless of -s).</span></span><br><span class="line">    <span class="keyword">bool</span> known_command = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (known_command == <span class="literal">true</span>) &#123;</span><br><span class="line">          runtime.addOption(strdup(argv[i]));</span><br><span class="line">          <span class="comment">// The static analyzer gets upset that we don't ever free the above</span></span><br><span class="line">          <span class="comment">// string. Since the allocation is from main, leaking it doesn't seem</span></span><br><span class="line">          <span class="comment">// problematic. NOLINTNEXTLINE</span></span><br><span class="line">          ALOGV(<span class="string">"app_process main add known option '%s'"</span>, argv[i]);</span><br><span class="line">          known_command = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">             j &lt; <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(<span class="keyword">sizeof</span>(spaced_commands) / <span class="keyword">sizeof</span>(spaced_commands[<span class="number">0</span>]));</span><br><span class="line">             ++j) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], spaced_commands[j]) == <span class="number">0</span>) &#123;</span><br><span class="line">            known_command = <span class="literal">true</span>;</span><br><span class="line">            ALOGV(<span class="string">"app_process main found known command '%s'"</span>, argv[i]);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">0</span>] != <span class="string">'-'</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i][<span class="number">1</span>] == <span class="string">'-'</span> &amp;&amp; argv[i][<span class="number">2</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">            ++i; <span class="comment">// Skip --.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        runtime.addOption(strdup(argv[i]));</span><br><span class="line">        <span class="comment">// The static analyzer gets upset that we don't ever free the above</span></span><br><span class="line">        <span class="comment">// string. Since the allocation is from main, leaking it doesn't seem</span></span><br><span class="line">        <span class="comment">// problematic. NOLINTNEXTLINE</span></span><br><span class="line">        ALOGV(<span class="string">"app_process main add option '%s'"</span>, argv[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse runtime arguments.  Stop at first unrecognized option.</span></span><br><span class="line">    <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line"></span><br><span class="line">    ++i;  <span class="comment">// Skip unused "parent dir" argument.</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector&lt;String8&gt; args;</span><br><span class="line">    <span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// We're not in zygote mode, the only argument we need to pass</span></span><br><span class="line">        <span class="comment">// to RuntimeInit is the application argument.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// The Remainder of args get passed to startup class main(). Make</span></span><br><span class="line">        <span class="comment">// copies of them before we overwrite them with the process name.</span></span><br><span class="line">        args.add(application ? String8(<span class="string">"application"</span>) : String8(<span class="string">"tool"</span>));</span><br><span class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!LOG_NDEBUG) &#123;</span><br><span class="line">          String8 restOfArgs;</span><br><span class="line">          <span class="keyword">char</span>* <span class="keyword">const</span>* argv_new = argv + i;</span><br><span class="line">          <span class="keyword">int</span> argc_new = argc - i;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; argc_new; ++k) &#123;</span><br><span class="line">            restOfArgs.append(<span class="string">"\""</span>);</span><br><span class="line">            restOfArgs.append(argv_new[k]);</span><br><span class="line">            restOfArgs.append(<span class="string">"\" "</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          ALOGV(<span class="string">"Class name = %s, args = %s"</span>, className.<span class="built_in">string</span>(), restOfArgs.<span class="built_in">string</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// We're in zygote mode.</span></span><br><span class="line">        maybeCreateDalvikCache();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            args.add(String8(<span class="string">"start-system-server"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> prop[PROP_VALUE_MAX];</span><br><span class="line">        <span class="keyword">if</span> (property_get(ABI_LIST_PROPERTY, prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">"app_process: Unable to determine ABI list from property %s."</span>,</span><br><span class="line">                ABI_LIST_PROPERTY);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">String8 <span class="title">abiFlag</span><span class="params">(<span class="string">"--abi-list="</span>)</span></span>;</span><br><span class="line">        abiFlag.append(prop);</span><br><span class="line">        args.add(abiFlag);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In zygote mode, pass all remaining arguments to the zygote</span></span><br><span class="line">        <span class="comment">// main() method.</span></span><br><span class="line">        <span class="keyword">for</span> (; i &lt; argc; ++i) &#123;</span><br><span class="line">            args.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!niceName.isEmpty()) &#123;</span><br><span class="line">        runtime.setArgv0(niceName.<span class="built_in">string</span>(), <span class="literal">true</span> <span class="comment">/* setProcName */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Xposed的app_main.cpp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">"appproc"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/properties.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/IPCThreadState.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;binder/ProcessState.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/process_name.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android_runtime/AndroidRuntime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_SDK_VERSION &gt;= 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/personality.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"xposed.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> isXposedLoaded = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">app_usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">        <span class="string">"Usage: app_process [java-options] cmd-dir start-class-name [options]\n"</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"   with Xposed support\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _atrace_set_tracing_enabled(<span class="keyword">bool</span> enabled)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (xposed::getSdkVersion() &lt; <span class="number">18</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    dlerror(); <span class="comment">// Clear existing errors</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*PTR_atrace_set_tracing_enabled)(<span class="keyword">bool</span>);</span><br><span class="line">    *(<span class="keyword">void</span> **) (&amp;PTR_atrace_set_tracing_enabled) = dlsym(RTLD_DEFAULT, <span class="string">"atrace_set_tracing_enabled"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *error;</span><br><span class="line">    <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not find address for function atrace_set_tracing_enabled: %s"</span>, error);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PTR_atrace_set_tracing_enabled(enabled);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRuntime</span> :</span> <span class="keyword">public</span> AndroidRuntime</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    AppRuntime()</span><br><span class="line">        : mParentDir(<span class="literal">NULL</span>)</span><br><span class="line">        , mClassName(<span class="literal">NULL</span>)</span><br><span class="line">        , mClass(<span class="literal">NULL</span>)</span><br><span class="line">        , mArgC(<span class="number">0</span>)</span><br><span class="line">        , mArgV(<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    <span class="comment">// this appears to be unused</span></span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">getParentDir</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mParentDir;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">getClassName</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mClassName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onVmCreated</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isXposedLoaded)</span><br><span class="line">            xposed::onVmCreated(env);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mClassName == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// Zygote. Nothing to do here.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This is a little awkward because the JNI FindClass call uses the</span></span><br><span class="line"><span class="comment">         * class loader associated with the native method we're executing in.</span></span><br><span class="line"><span class="comment">         * If called in onStarted (from RuntimeInit.finishInit because we're</span></span><br><span class="line"><span class="comment">         * launching "am", for example), FindClass would see that we're calling</span></span><br><span class="line"><span class="comment">         * from a boot class' native method, and so wouldn't look for the class</span></span><br><span class="line"><span class="comment">         * we're trying to look up in CLASSPATH. Unfortunately it needs to,</span></span><br><span class="line"><span class="comment">         * because the "am" classes are not boot classes.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The easiest fix is to call FindClass here, early on before we start</span></span><br><span class="line"><span class="comment">         * executing boot class Java code and thereby deny ourselves access to</span></span><br><span class="line"><span class="comment">         * non-boot classes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">char</span>* slashClassName = toSlashClassName(mClassName);</span><br><span class="line">        mClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">        <span class="keyword">if</span> (mClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"ERROR: could not find class '%s'\n"</span>, mClassName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">        mClass = <span class="keyword">reinterpret_cast</span>&lt;jclass&gt;(env-&gt;NewGlobalRef(mClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">        AndroidRuntime* ar = AndroidRuntime::getRuntime();</span><br><span class="line">        ar-&gt;callMain(mClassName, mClass, mArgC, mArgV);</span><br><span class="line"></span><br><span class="line">        IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Re-enable tracing now that we're no longer in Zygote.</span></span><br><span class="line">        _atrace_set_tracing_enabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onExit</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClassName == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// if zygote</span></span><br><span class="line">            IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AndroidRuntime::onExit(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* mParentDir;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* mClassName;</span><br><span class="line">    jclass mClass;</span><br><span class="line">    <span class="keyword">int</span> mArgC;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>* mArgV;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sets argv0 to as much of newArgv0 as will fit</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setArgv0</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *argv0, <span class="keyword">const</span> <span class="keyword">char</span> *newArgv0)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    strlcpy(<span class="keyword">const_cast</span>&lt;<span class="keyword">char</span> *&gt;(argv0), newArgv0, <span class="built_in">strlen</span>(argv0));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (xposed::handleOptions(argc, argv))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_SDK_VERSION &gt;= 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __arm__</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * b/7188322 - Temporarily revert to the compat memory layout</span></span><br><span class="line"><span class="comment">     * to avoid breaking third party apps.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * THIS WILL GO AWAY IN A FUTURE ANDROID RELEASE.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=7dbaa466</span></span><br><span class="line"><span class="comment">     * changes the kernel mapping from bottom up to top-down.</span></span><br><span class="line"><span class="comment">     * This breaks some programs which improperly embed</span></span><br><span class="line"><span class="comment">     * an out of date copy of Android's linker.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">char</span> value[PROPERTY_VALUE_MAX];</span><br><span class="line">    property_get(<span class="string">"ro.kernel.qemu"</span>, value, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">bool</span> is_qemu = (<span class="built_in">strcmp</span>(value, <span class="string">"1"</span>) == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((getenv(<span class="string">"NO_ADDR_COMPAT_LAYOUT_FIXUP"</span>) == <span class="literal">NULL</span>) &amp;&amp; !is_qemu) &#123;</span><br><span class="line">        <span class="keyword">int</span> current = personality(<span class="number">0xFFFFFFFF</span>);</span><br><span class="line">        <span class="keyword">if</span> ((current &amp; ADDR_COMPAT_LAYOUT) == <span class="number">0</span>) &#123;</span><br><span class="line">            personality(current | ADDR_COMPAT_LAYOUT);</span><br><span class="line">            setenv(<span class="string">"NO_ADDR_COMPAT_LAYOUT_FIXUP"</span>, <span class="string">"1"</span>, <span class="number">1</span>);</span><br><span class="line">            execv(<span class="string">"/system/bin/app_process"</span>, argv);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    unsetenv(<span class="string">"NO_ADDR_COMPAT_LAYOUT_FIXUP"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// These are global variables in ProcessState.cpp</span></span><br><span class="line">    mArgC = argc;</span><br><span class="line">    mArgV = argv;</span><br><span class="line"></span><br><span class="line">    mArgLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;argc; i++) &#123;</span><br><span class="line">        mArgLen += <span class="built_in">strlen</span>(argv[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mArgLen--;</span><br><span class="line"></span><br><span class="line">    AppRuntime runtime;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* argv0 = argv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process command line arguments</span></span><br><span class="line">    <span class="comment">// ignore argv[0]</span></span><br><span class="line">    argc--;</span><br><span class="line">    argv++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Everything up to '--' or first non '-' arg goes to the vm</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = runtime.addVmArguments(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse runtime arguments.  Stop at first unrecognized option.</span></span><br><span class="line">    <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* parentDir = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* niceName = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* className = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (!parentDir) &#123;</span><br><span class="line">            parentDir = arg;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = <span class="string">"zygote"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName = arg + <span class="number">12</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            className = arg;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (niceName &amp;&amp; *niceName) &#123;</span><br><span class="line">        setArgv0(argv0, niceName);</span><br><span class="line">        set_process_name(niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runtime.mParentDir = parentDir;</span><br><span class="line"></span><br><span class="line">    isXposedLoaded = xposed::initialize(zygote, startSystemServer, className, argc, argv);</span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        runtime.start(isXposedLoaded ? XPOSED_CLASS_DOTS_ZYGOTE : <span class="string">"com.android.internal.os.ZygoteInit"</span>,</span><br><span class="line">                startSystemServer ? <span class="string">"start-system-server"</span> : <span class="string">""</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        <span class="comment">// Remainder of args get passed to startup class main()</span></span><br><span class="line">        runtime.mClassName = className;</span><br><span class="line">        runtime.mArgC = argc - i;</span><br><span class="line">        runtime.mArgV = argv + i;</span><br><span class="line">        runtime.start(isXposedLoaded ? XPOSED_CLASS_DOTS_TOOLS : <span class="string">"com.android.internal.os.RuntimeInit"</span>,</span><br><span class="line">                application ? <span class="string">"application"</span> : <span class="string">"tool"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对比：</p>
<p>1 低版本atrace_set_tracing_enabled替换：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _atrace_set_tracing_enabled(<span class="keyword">bool</span> enabled)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (xposed::getSdkVersion() &lt; <span class="number">18</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    dlerror(); <span class="comment">// Clear existing errors</span></span><br><span class="line">    <span class="keyword">void</span> (*PTR_atrace_set_tracing_enabled)(<span class="keyword">bool</span>);</span><br><span class="line">    *(<span class="keyword">void</span> **) (&amp;PTR_atrace_set_tracing_enabled) = dlsym(RTLD_DEFAULT, <span class="string">"atrace_set_tracing_enabled"</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *error;</span><br><span class="line">    <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not find address for function atrace_set_tracing_enabled: %s"</span>, error);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PTR_atrace_set_tracing_enabled(enabled);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 onVmCreated中添加Xposed回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onVmCreated</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isXposedLoaded)</span><br><span class="line">            xposed::onVmCreated(env);</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3 在main中添加handleOptions操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (xposed::handleOptions(argc, argv))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Xposed.cpp.handleOptions:处理一些xposed的特殊命令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Handle special command line options. */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">handleOptions</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span> </span>&#123;</span><br><span class="line">    parseXposedProp();</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">2</span> &amp;&amp; <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--xposedversion"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Xposed version: %s\n"</span>, xposedVersion);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">2</span> &amp;&amp; <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--xposedtestsafemode"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Testing Xposed safemode trigger\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (detectSafemodeTrigger(shouldSkipSafemodeDelay())) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Safemode triggered\n"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Safemode not triggered\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// From Lollipop coding, used to override the process name</span></span><br><span class="line">    argBlockStart = argv[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">uintptr_t</span> start = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">uintptr_t</span> end = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(argv[argc - <span class="number">1</span>]);</span><br><span class="line">    end += <span class="built_in">strlen</span>(argv[argc - <span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line">    argBlockLength = end - start;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4 main函数中，int main(int argc, char* const argv[])启动的时候增加了启动一些逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">isXposedLoaded = xposed::initialize(zygote, startSystemServer, className, argc, argv);</span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        <span class="comment">// 当xposed成功启动的时候，start XPOSED_CLASS_DOTS_ZYGOTE这个类</span></span><br><span class="line">        runtime.start(isXposedLoaded ? XPOSED_CLASS_DOTS_ZYGOTE : <span class="string">"com.android.internal.os.ZygoteInit"</span>,</span><br><span class="line">                startSystemServer ? <span class="string">"start-system-server"</span> : <span class="string">""</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        <span class="comment">// Remainder of args get passed to startup class main()</span></span><br><span class="line">        runtime.mClassName = className;</span><br><span class="line">        runtime.mArgC = argc - i;</span><br><span class="line">        runtime.mArgV = argv + i;</span><br><span class="line">        <span class="comment">// 当xposed成功启动的时候，start XPOSED_CLASS_DOTS_ZYGOTE这个类</span></span><br><span class="line">        runtime.start(isXposedLoaded ? XPOSED_CLASS_DOTS_TOOLS : <span class="string">"com.android.internal.os.RuntimeInit"</span>,</span><br><span class="line">                application ? <span class="string">"application"</span> : <span class="string">"tool"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中，XPOSED_CLASS_DOTS_ZYGOTE 变量在，xposed.h头文件中有定义，如下所示。其实这个类就是我们之前向私有目录放置的XposedBridge项目的包名</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XPOSED_CLASS_DOTS_ZYGOTE <span class="meta-string">"de.robv.android.xposed.XposedBridge"</span></span></span><br></pre></td></tr></table></figure>
<p>AndroidRuntime.start()，位于源码/frameworks/base/core/jni/AndroidRuntime.cpp。OK，这里可以看出，从这里开始调用XposedBridge.java的”static void main(String[] args)”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start the Android runtime.  This involves starting the virtual machine</span></span><br><span class="line"><span class="comment"> * and calling the "static void main(String[] args)" method in the class</span></span><br><span class="line"><span class="comment"> * named by "className".</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Passes the main function two arguments, the class name and the specified</span></span><br><span class="line"><span class="comment"> * options string.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span><br></pre></td></tr></table></figure>
<p>XposedBridge.main</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Initialize the Xposed framework and modules</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hadInitErrors()) &#123;</span><br><span class="line">            initXResources();</span><br><span class="line">            SELinuxHelper.initOnce();</span><br><span class="line">            SELinuxHelper.initForProcess(<span class="keyword">null</span>);</span><br><span class="line">            runtime = getRuntime();</span><br><span class="line">            XPOSED_BRIDGE_VERSION = getXposedVersion();</span><br><span class="line">            <span class="keyword">if</span> (isZygote) &#123;</span><br><span class="line">                <span class="comment">// 为启动一个新的 zygote做好 hook准备</span></span><br><span class="line">                XposedInit.hookResources();</span><br><span class="line">                XposedInit.initForZygote();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 载入Xposed的一些modules</span></span><br><span class="line">            XposedInit.loadModules();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Not initializing Xposed because of previous errors"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Errors during Xposed initialization"</span>, t);</span><br><span class="line">        disableHooks = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用系统原来的启动方法</span></span><br><span class="line">    <span class="keyword">if</span> (isZygote) &#123;</span><br><span class="line">        ZygoteInit.main(args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        RuntimeInit.main(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-将xposed的api文件，XposedBridge-jar文件放置到私有目录中"><a href="#2-将xposed的api文件，XposedBridge-jar文件放置到私有目录中" class="headerlink" title="2 将xposed的api文件，XposedBridge.jar文件放置到私有目录中"></a>2 将xposed的api文件，XposedBridge.jar文件放置到私有目录中</h3><p>1 下载XposedBridge放到/data/data/de.robv.android.xposed.installer/bin目录下<br>2 安装框架后替换/system/bin/app_process，原始app_process备份为：app_process_original,app_process_xposed</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createDirectories</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FileUtils.setPermissions(BASE_DIR, <span class="number">00711</span>, -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">    mkdirAndChmod(<span class="string">"conf"</span>, <span class="number">00771</span>);</span><br><span class="line">    mkdirAndChmod(<span class="string">"log"</span>, <span class="number">00777</span>);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mkdirAndChmod</span><span class="params">(String dir, <span class="keyword">int</span> permissions)</span> </span>&#123;</span><br><span class="line">    dir = BASE_DIR + dir;</span><br><span class="line">    <span class="keyword">new</span> File(dir).mkdir();</span><br><span class="line">    FileUtils.setPermissions(dir, permissions, -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BASE_DIR_LEGACY = <span class="string">"/data/data/de.robv.android.xposed.installer/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BASE_DIR = Build.VERSION.SDK_INT &gt;= <span class="number">24</span></span><br><span class="line">        ? <span class="string">"/data/user_de/0/de.robv.android.xposed.installer/"</span> : BASE_DIR_LEGACY;</span><br></pre></td></tr></table></figure>
<h2 id="下载脚本文件"><a href="#下载脚本文件" class="headerlink" title="下载脚本文件"></a>下载脚本文件</h2><p>这里只是下载了update-binary脚本文件，将具体的文件操作细节封装到了脚本中。而update-binary就是以升级系统的形式来实现对应的文件操作。拷贝了update-binary，在下次重启的时候就会执行对这个脚本文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flash</span><span class="params">(Context context, FlashCallback callback)</span> </span>&#123;</span><br><span class="line">    ZipCheckResult zipCheck = openAndCheckZip(callback);</span><br><span class="line">    <span class="keyword">if</span> (zipCheck == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do additional checks.</span></span><br><span class="line">    ZipFile zip = zipCheck.getZip();</span><br><span class="line">    <span class="keyword">if</span> (!zipCheck.isFlashableInApp()) &#123;</span><br><span class="line">        triggerError(callback, FlashCallback.ERROR_NOT_FLASHABLE_IN_APP);</span><br><span class="line">        closeSilently(zip);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提取 update-binary 到data/data/de.robv.android.xposed.installer/cache目录</span></span><br><span class="line">    ZipEntry entry = zip.getEntry(<span class="string">"META-INF/com/google/android/update-binary"</span>);</span><br><span class="line">    File updateBinaryFile = <span class="keyword">new</span> File(XposedApp.getInstance().getCacheDir(), <span class="string">"update-binary"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AssetUtil.writeStreamToFile(zip.getInputStream(entry), updateBinaryFile, <span class="number">0700</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Log.e(XposedApp.TAG, <span class="string">"Could not extract update-binary"</span>, e);</span><br><span class="line">        triggerError(callback, FlashCallback.ERROR_INVALID_ZIP);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        closeSilently(zip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Execute the flash commands.</span></span><br><span class="line">    RootUtil rootUtil = <span class="keyword">new</span> RootUtil();</span><br><span class="line">    <span class="comment">// 启动shell</span></span><br><span class="line">    <span class="keyword">if</span> (!rootUtil.startShell(callback)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    callback.onStarted();</span><br><span class="line">    <span class="comment">// 添加内部环境变量</span></span><br><span class="line">    rootUtil.execute(<span class="string">"export NO_UIPRINT=1"</span>, callback);</span><br><span class="line">    <span class="keyword">if</span> (mSystemless) &#123;</span><br><span class="line">        rootUtil.execute(<span class="string">"export SYSTEMLESS=1"</span>, callback);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// /data/data/de.robv.android.xposed.installer/cache/update-binary 2 1 /storage/emulated/0/Android/data/de.robv.android.xposed.installer/cache/downloads/framework/xposed-v89-sdk23-arm.zip</span></span><br><span class="line">    <span class="keyword">int</span> result = rootUtil.execute(getShellPath(updateBinaryFile) + <span class="string">" 2 1 "</span> + getShellPath(mZipPath), callback);</span><br><span class="line">    <span class="keyword">if</span> (result != FlashCallback.OK) &#123;</span><br><span class="line">        triggerError(callback, result);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    callback.onDone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行shell命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> NO_UIPRINT=1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> SYSTEMLESS=1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> /data/data/de.robv.android.xposed.installer/cache/update-binary 2 1 /storage/emulated/0/Android/data/de.robv.android.xposed.installer/cache/downloads/framework/xposed-v89-sdk23-arm.zip</span></span><br></pre></td></tr></table></figure>
<h2 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h2><p>解压/storage/emulated/0/Android/data/de.robv.android.xposed.installer/cache/downloads/framework/xposed-v89-sdk23-arm.zip查看里面文件。</p>
<ul>
<li>META_INF:com/google/android-&gt; update-binar,flash-script.sh,updater-script</li>
<li>system/bin:app_process32_xposed,dex2oat,oatdump,patchoat需替换的文件</li>
<li>system/framework:XposedBridge.jar</li>
<li>system/xposed.prop: version=89 arch=arm minsdk=23 maxsdk=23</li>
<li>system/lib:新增的.so文件</li>
</ul>
<p>执行 META-INF/com/google/android/flash-script.sh，</p>
<p>XposedBridge.jar拷贝到系统/system/framework/XposedBridge.jar，app_process文件替换，.so文件导入，以及核心实现替换。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########################################################################################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Xposed framework installer zip.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This script installs the Xposed framework files to the system partition.</span></span><br><span class="line"><span class="comment"># The Xposed Installer app is needed as well to manage the installed modules.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">##########################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">grep_prop</span></span>() &#123;</span><br><span class="line">  REGEX=<span class="string">"s/^<span class="variable">$1</span>=//p"</span></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">  FILES=<span class="variable">$@</span></span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$FILES</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    FILES=<span class="string">'/system/build.prop'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  cat <span class="variable">$FILES</span> 2&gt;/dev/null | sed -n <span class="variable">$REGEX</span> | head -n 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">android_version</span></span>() &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">    15) <span class="built_in">echo</span> <span class="string">'4.0 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    16) <span class="built_in">echo</span> <span class="string">'4.1 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    17) <span class="built_in">echo</span> <span class="string">'4.2 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    18) <span class="built_in">echo</span> <span class="string">'4.3 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    19) <span class="built_in">echo</span> <span class="string">'4.4 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    21) <span class="built_in">echo</span> <span class="string">'5.0 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    22) <span class="built_in">echo</span> <span class="string">'5.1 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    23) <span class="built_in">echo</span> <span class="string">'6.0 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    24) <span class="built_in">echo</span> <span class="string">'7.0 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    25) <span class="built_in">echo</span> <span class="string">'7.1 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    26) <span class="built_in">echo</span> <span class="string">'8.0 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    27) <span class="built_in">echo</span> <span class="string">'8.1 / SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">    *)  <span class="built_in">echo</span> <span class="string">'SDK'</span><span class="variable">$1</span>;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">cp_perm</span></span>() &#123;</span><br><span class="line">  cp -f <span class="variable">$1</span> <span class="variable">$2</span> || <span class="built_in">exit</span> 1</span><br><span class="line">  set_perm <span class="variable">$2</span> <span class="variable">$3</span> <span class="variable">$4</span> <span class="variable">$5</span> <span class="variable">$6</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set_perm</span></span>() &#123;</span><br><span class="line">  chown <span class="variable">$2</span>:<span class="variable">$3</span> <span class="variable">$1</span> || <span class="built_in">exit</span> 1</span><br><span class="line">  chmod <span class="variable">$4</span> <span class="variable">$1</span> || <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$5</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    chcon <span class="variable">$5</span> <span class="variable">$1</span> 2&gt;/dev/null</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    chcon <span class="string">'u:object_r:system_file:s0'</span> <span class="variable">$1</span> 2&gt;/dev/null</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_nobackup</span></span>() &#123;</span><br><span class="line">  cp_perm ./<span class="variable">$1</span> <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$3</span> <span class="variable">$4</span> <span class="variable">$5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_and_link</span></span>() &#123;</span><br><span class="line">  TARGET=<span class="variable">$1</span></span><br><span class="line">  XPOSED=<span class="string">"<span class="variable">$&#123;1&#125;</span>_xposed"</span></span><br><span class="line">  BACKUP=<span class="string">"<span class="variable">$&#123;1&#125;</span>_original"</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -f ./<span class="variable">$XPOSED</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  cp_perm ./<span class="variable">$XPOSED</span> <span class="variable">$XPOSED</span> <span class="variable">$2</span> <span class="variable">$3</span> <span class="variable">$4</span> <span class="variable">$5</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -f <span class="variable">$BACKUP</span> ]; <span class="keyword">then</span></span><br><span class="line">    mv <span class="variable">$TARGET</span> <span class="variable">$BACKUP</span> || <span class="built_in">exit</span> 1</span><br><span class="line">    ln -s <span class="variable">$XPOSED</span> <span class="variable">$TARGET</span> || <span class="built_in">exit</span> 1</span><br><span class="line">    chcon -h <span class="string">'u:object_r:system_file:s0'</span> <span class="variable">$TARGET</span> 2&gt;/dev/null</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_overwrite</span></span>() &#123;</span><br><span class="line">  TARGET=<span class="variable">$1</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -f ./<span class="variable">$TARGET</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  BACKUP=<span class="string">"<span class="variable">$&#123;1&#125;</span>.orig"</span></span><br><span class="line">  NO_ORIG=<span class="string">"<span class="variable">$&#123;1&#125;</span>.no_orig"</span></span><br><span class="line">  <span class="keyword">if</span> [ ! -f <span class="variable">$TARGET</span> ]; <span class="keyword">then</span></span><br><span class="line">    touch <span class="variable">$NO_ORIG</span> || <span class="built_in">exit</span> 1</span><br><span class="line">    set_perm <span class="variable">$NO_ORIG</span> 0 0 600</span><br><span class="line">  <span class="keyword">elif</span> [ -f <span class="variable">$BACKUP</span> ]; <span class="keyword">then</span></span><br><span class="line">    rm -f <span class="variable">$TARGET</span></span><br><span class="line">    gzip <span class="variable">$BACKUP</span> || <span class="built_in">exit</span> 1</span><br><span class="line">    set_perm <span class="string">"<span class="variable">$&#123;BACKUP&#125;</span>.gz"</span> 0 0 600</span><br><span class="line">  <span class="keyword">elif</span> [ ! -f <span class="string">"<span class="variable">$&#123;BACKUP&#125;</span>.gz"</span> -a ! -f <span class="variable">$NO_ORIG</span> ]; <span class="keyword">then</span></span><br><span class="line">    mv <span class="variable">$TARGET</span> <span class="variable">$BACKUP</span> || <span class="built_in">exit</span> 1</span><br><span class="line">    gzip <span class="variable">$BACKUP</span> || <span class="built_in">exit</span> 1</span><br><span class="line">    set_perm <span class="string">"<span class="variable">$&#123;BACKUP&#125;</span>.gz"</span> 0 0 600</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  cp_perm ./<span class="variable">$TARGET</span> <span class="variable">$TARGET</span> <span class="variable">$2</span> <span class="variable">$3</span> <span class="variable">$4</span> <span class="variable">$5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##########################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"******************************"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Xposed framework installer zip"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"******************************"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">"system/xposed.prop"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"! Failed: Extracted file system/xposed.prop not found!"</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- Mounting /system and /vendor read-write"</span></span><br><span class="line">mount /system &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">mount /vendor &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">mount -o remount,rw /system</span><br><span class="line">mount -o remount,rw /vendor &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">'/system/build.prop'</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"! Failed: /system could not be mounted!"</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- Checking environment"</span></span><br><span class="line">API=$(grep_prop ro.build.version.sdk)</span><br><span class="line">APINAME=$(android_version <span class="variable">$API</span>)</span><br><span class="line">ABI=$(grep_prop ro.product.cpu.abi | cut -c-3)</span><br><span class="line">ABI2=$(grep_prop ro.product.cpu.abi2 | cut -c-3)</span><br><span class="line">ABILONG=$(grep_prop ro.product.cpu.abi)</span><br><span class="line"></span><br><span class="line">XVERSION=$(grep_prop version system/xposed.prop)</span><br><span class="line">XARCH=$(grep_prop arch system/xposed.prop)</span><br><span class="line">XMINSDK=$(grep_prop minsdk system/xposed.prop)</span><br><span class="line">XMAXSDK=$(grep_prop maxsdk system/xposed.prop)</span><br><span class="line"></span><br><span class="line">XEXPECTEDSDK=$(android_version <span class="variable">$XMINSDK</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$XMINSDK</span>"</span> != <span class="string">"<span class="variable">$XMAXSDK</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">  XEXPECTEDSDK=<span class="variable">$XEXPECTEDSDK</span><span class="string">' - '</span>$(android_version <span class="variable">$XMAXSDK</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ARCH=arm</span><br><span class="line">IS64BIT=</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$ABI</span>"</span> = <span class="string">"x86"</span> ]; <span class="keyword">then</span> ARCH=x86; <span class="keyword">fi</span>;</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$ABI2</span>"</span> = <span class="string">"x86"</span> ]; <span class="keyword">then</span> ARCH=x86; <span class="keyword">fi</span>;</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$API</span>"</span> -ge <span class="string">"21"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$ABILONG</span>"</span> = <span class="string">"arm64-v8a"</span> ]; <span class="keyword">then</span> ARCH=arm64; IS64BIT=1; <span class="keyword">fi</span>;</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$ABILONG</span>"</span> = <span class="string">"x86_64"</span> ]; <span class="keyword">then</span> ARCH=x64; IS64BIT=1; <span class="keyword">fi</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo "DBG [$API] [$ABI] [$ABI2] [$ABILONG] [$ARCH] [$XARCH] [$XMINSDK] [$XMAXSDK] [$XVERSION]"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"  Xposed version: <span class="variable">$XVERSION</span>"</span></span><br><span class="line"></span><br><span class="line">XVALID=</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$ARCH</span>"</span> = <span class="string">"<span class="variable">$XARCH</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$API</span>"</span> -ge <span class="string">"<span class="variable">$XMINSDK</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$API</span>"</span> -le <span class="string">"<span class="variable">$XMAXSDK</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">      XVALID=1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"! Wrong Android version: <span class="variable">$APINAME</span>"</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"! This file is for: <span class="variable">$XEXPECTEDSDK</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"! Wrong Android version: <span class="variable">$APINAME</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"! This file is for: <span class="variable">$XEXPECTEDSDK</span>"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"! Wrong platform: <span class="variable">$ARCH</span>"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"! This file is for: <span class="variable">$XARCH</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$XVALID</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"! Please download the correct package"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"! for your platform/ROM!"</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- Placing files"</span></span><br><span class="line">install_nobackup /system/xposed.prop                      0    0 0644</span><br><span class="line">install_nobackup /system/framework/XposedBridge.jar       0    0 0644</span><br><span class="line"></span><br><span class="line">install_and_link  /system/bin/app_process32               0 2000 0755 u:object_r:zygote_exec:s0</span><br><span class="line">install_overwrite /system/bin/dex2oat                     0 2000 0755 u:object_r:dex2oat_exec:s0</span><br><span class="line">install_overwrite /system/bin/oatdump                     0 2000 0755</span><br><span class="line">install_overwrite /system/bin/patchoat                    0 2000 0755 u:object_r:dex2oat_exec:s0</span><br><span class="line">install_overwrite /system/lib/libart.so                   0    0 0644</span><br><span class="line">install_overwrite /system/lib/libart-compiler.so          0    0 0644</span><br><span class="line">install_overwrite /system/lib/libart-disassembler.so      0    0 0644</span><br><span class="line">install_overwrite /system/lib/libsigchain.so              0    0 0644</span><br><span class="line">install_nobackup  /system/lib/libxposed_art.so            0    0 0644</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$IS64BIT</span> ]; <span class="keyword">then</span></span><br><span class="line">  install_and_link  /system/bin/app_process64             0 2000 0755 u:object_r:zygote_exec:s0</span><br><span class="line">  install_overwrite /system/lib64/libart.so               0    0 0644</span><br><span class="line">  install_overwrite /system/lib64/libart-compiler.so      0    0 0644</span><br><span class="line">  install_overwrite /system/lib64/libart-disassembler.so  0    0 0644</span><br><span class="line">  install_overwrite /system/lib64/libsigchain.so          0    0 0644</span><br><span class="line">  install_nobackup  /system/lib64/libxposed_art.so        0    0 0644</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$API</span>"</span> -ge <span class="string">"22"</span> ]; <span class="keyword">then</span></span><br><span class="line">  find /system /vendor -<span class="built_in">type</span> f -name <span class="string">'*.odex.gz'</span> 2&gt;/dev/null | <span class="keyword">while</span> <span class="built_in">read</span> f; <span class="keyword">do</span> mv <span class="string">"<span class="variable">$f</span>"</span> <span class="string">"<span class="variable">$f</span>.xposed"</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- Done"</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>
<h2 id="Android-Hock实现"><a href="#Android-Hock实现" class="headerlink" title="Android Hock实现"></a>Android Hock实现</h2><h3 id="1-设置依赖app-build"><a href="#1-设置依赖app-build" class="headerlink" title="1 设置依赖app/build"></a>1 设置依赖app/build</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">'de.robv.android.xposed:api:82'</span></span><br><span class="line"><span class="comment">//如果需要引入文档，方便查看的话</span></span><br><span class="line">compileOnly <span class="string">'de.robv.android.xposed:api:82:sources'</span></span><br></pre></td></tr></table></figure>
<h3 id="2-assets-xposed-init文件"><a href="#2-assets-xposed-init文件" class="headerlink" title="2 assets/xposed_init文件"></a>2 assets/xposed_init文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.example.hook.hooktest.SetTextHook</span><br></pre></td></tr></table></figure>
<h3 id="3-配置manifest"><a href="#3-配置manifest" class="headerlink" title="3 配置manifest"></a>3 配置manifest</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1、标识自己是否为一个Xposed模块 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"xposedmodule"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 2、Xposed模块的描述信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"xposeddescription"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">"a sample hook"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 3、支持Xposed框架的最低版本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"xposedminversion"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">"53"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-hook代码编写"><a href="#4-hook代码编写" class="headerlink" title="4 hook代码编写"></a>4 hook代码编写</h3><p>handleLoadPackage 内部实现方法的hook。当需要hook多个方法时可以依次写多个方法。hook代码大部分通过反射调用。afterHookedMethod的param的get/setResult获取设置返回参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SetTextHook</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(<span class="keyword">final</span> XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!lpparam.packageName.equals(<span class="string">"xxxx"</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//log 在xposed installer查看</span></span><br><span class="line">        XposedBridge.log(<span class="string">"Hook测试程序"</span> + lpparam.packageName);</span><br><span class="line">        XposedHelpers.findAndHookMethod(<span class="string">"xxx"</span>, lpparam.classLoader, <span class="string">"a"</span>, lpparam.classLoader.loadClass(<span class="string">"xxxxx"</span>), <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * onCreate之前回调</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> param  onCreate方法的信息，可以修改</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">"Hook xxx方法前"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Object result = param.getResult();</span><br><span class="line">                <span class="comment">// 获取okhttpclient</span></span><br><span class="line">                Class okhttp = lpparam.classLoader.loadClass(<span class="string">"okhttp3.OkHttpClient"</span>);</span><br><span class="line">                Class build = lpparam.classLoader.loadClass(<span class="string">"okhttp3.OkHttpClient$Builder"</span>);</span><br><span class="line"></span><br><span class="line">                Method method = okhttp.getDeclaredMethod(<span class="string">"connectTimeoutMillis"</span>);</span><br><span class="line">                Constructor constructor = build.getDeclaredConstructor(okhttp);</span><br><span class="line">                constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                Method buildM = build.getDeclaredMethod(<span class="string">"build"</span>);</span><br><span class="line">                Object buildObj = constructor.newInstance(result);</span><br><span class="line"></span><br><span class="line"><span class="comment">//                Method connectTimeout = build.getDeclaredMethod("connectTimeout", long.class, lpparam.classLoader.loadClass("java.util.concurrent.TimeUnit"));</span></span><br><span class="line"><span class="comment">//                Class time = lpparam.classLoader.loadClass("java.util.concurrent.TimeUnit");</span></span><br><span class="line"><span class="comment">//                Object[] consts = time.getEnumConstants();</span></span><br><span class="line"><span class="comment">//                connectTimeout.invoke(buildObj, 10, consts[3]);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> X509TrustManager e = <span class="keyword">new</span> X509TrustManager() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkClientTrusted</span><span class="params">(<span class="keyword">final</span> X509Certificate[] array, <span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkServerTrusted</span><span class="params">(<span class="keyword">final</span> X509Certificate[] array, <span class="keyword">final</span> String s)</span> </span>&#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> X509Certificate[<span class="number">0</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                SSLContext sslContext = SSLContext.getInstance(<span class="string">"SSL"</span>);</span><br><span class="line">                sslContext.init(<span class="keyword">null</span>, <span class="keyword">new</span> X509TrustManager[]&#123;e&#125;, <span class="keyword">null</span>);</span><br><span class="line">                SSLSocketFactory c = sslContext.getSocketFactory();</span><br><span class="line">                Method sslSocketFactory = build.getDeclaredMethod(<span class="string">"sslSocketFactory"</span>, lpparam.classLoader.loadClass(<span class="string">"javax.net.ssl.SSLSocketFactory"</span>), lpparam.classLoader.loadClass(<span class="string">"javax.net.ssl.X509TrustManager"</span>));</span><br><span class="line">                sslSocketFactory.invoke(buildObj, c, e);</span><br><span class="line"></span><br><span class="line">                result = buildM.invoke(buildObj);</span><br><span class="line">                param.setResult(result);</span><br><span class="line">                XposedBridge.log(<span class="string">"Hook xxx方法后"</span> + method.invoke(param.getResult()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        XposedHelpers.findAndHookMethod(<span class="string">"xxx"</span>, lpparam.classLoader, <span class="string">"a"</span>, Object.class, lpparam.classLoader.loadClass(<span class="string">"xxx"</span>), String.class, String.class, String.class, HashMap.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * onCreate之前回调</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> param  onCreate方法的信息，可以修改</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">"Hook xxx 错误返回前code:"</span> + param.args[<span class="number">3</span>]);</span><br><span class="line">                XposedBridge.log(<span class="string">"Hook xxx 错误返回前message:"</span> + param.args[<span class="number">4</span>]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        XposedHelpers.findAndHookMethod(<span class="string">"xxx"</span>, lpparam.classLoader, <span class="string">"a"</span>, Object.class, lpparam.classLoader.loadClass(<span class="string">"xxx"</span>), String.class, Object.class,  HashMap.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * onCreate之前回调</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> param  onCreate方法的信息，可以修改</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">"Hook xxx 成功返回body:"</span> + param.args[<span class="number">3</span>]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-安装hook-app"><a href="#5-安装hook-app" class="headerlink" title="5 安装hook app"></a>5 安装hook app</h3><p>安装成功后就可以在Xposed installer中管理对应的hook应用，开关，安装卸载等操作。首次安装或者升级后记得重启设备后生效。</p>
<h2 id="Xposed-VirtualXposed"><a href="#Xposed-VirtualXposed" class="headerlink" title="Xposed VirtualXposed"></a>Xposed VirtualXposed</h2><p>Xposed虽然功能强大，但是需要root才可以使用，但是root还是有一定的门槛的，对于小白用户来说太不方便了。因此推出了Virtual Xposed，Virtual Xposed相当于运行于自己的虚拟机环境下，而虚拟机环境和我们的系统是相互独立的，互不影响。Virtual Xposed的优点也是它的缺点，就是不能修改系统相关的操作，也不支持对资源的hook，但是可以实现对虚拟机中app的hook操作。</p>
<h2 id="Hook的使用场景"><a href="#Hook的使用场景" class="headerlink" title="Hook的使用场景"></a>Hook的使用场景</h2><p>Hook在我们日常开发中使用的并不多，比较适合对第三方sdk非我们自己的代码进行hook修改已达到特殊目的的操作。比如我们使用的sdk的某一个方法并没有实现对某个变量的动态设置功能，而我们测试的时候希望看一下动态设置的效果，这个时候hook就派上了用场。hook虽然可以对任意代码的任一方法进行hook处理，但这些都是在测试环境进行测试可以带来便利。因为用户的环境并不具备xposed的环境，因此hook方法并不适合生产环境的使用。</p>
<h2 id="VirtualXposed"><a href="#VirtualXposed" class="headerlink" title="VirtualXposed"></a>VirtualXposed</h2><p><a href="https://github.com/android-hacker/VirtualXposed">VirtualXposed</a> 是基于<a href="https://github.com/asLody/VirtualApp">VirtualApp</a> 和 <a href="https://github.com/tiann/epic">epic</a> 在非ROOT环境下运行Xposed模块的实现（支持5.0~9.0):</p>
<h3 id="VirtualApp"><a href="#VirtualApp" class="headerlink" title="VirtualApp"></a>VirtualApp</h3><p>VirtualApp 是一款运行于Android系统的沙盒产品，可以理解为轻量级的Android虚拟机。</p>
<p>Android应用隔离是基于Linux系统的多用户机制实现的，即每个应用在安装时被分配了不同的Linux用户 uid/gid。而在VirtualApp中client应用（通过VirtualApp安装的应用）与host应用（即VirtualApp 本身）是具有相同用户uid的。client app均是以VirtualApp的用户uid运行的，因此，Android应用隔离此时不再适用，我们可以对client应用进行hook而无需root权限。</p>
<p>VirtualApp 伪造了一套 framework 代码，实现所有在其进程启动的应用，都运行在一个虚拟空间。</p>
<h3 id="epic"><a href="#epic" class="headerlink" title="epic"></a>epic</h3><p>Epic 是一个在虚拟机层面、以 Java Method 为粒度的 运行时 AOP Hook 框架。简单来说，Epic 就是 ART 上的 <a href="https://github.com/alibaba/dexposed">Dexposed</a>（支持 Android 4.0 ~ 10.0），能在非root情况下掌控自己进程空间内的任意Java方法调用。它可以拦截本进程内部几乎任意的 Java 方法调用，可用于实现 AOP 编程、运行时插桩、性能分析、安全审计等。</p>
<h3 id="与Xposed相比VirtualXposed两个限制"><a href="#与Xposed相比VirtualXposed两个限制" class="headerlink" title="与Xposed相比VirtualXposed两个限制"></a>与Xposed相比VirtualXposed两个限制</h3><ul>
<li>1 不支持修改系统（可以修改普通APP中对系统API的调用），因此重力工具箱，应用控制器等无法使用。</li>
<li>2 暂不支持资源HOOK，因此资源钩子不会起任何作用；使用资源HOOK的模块，相应的功能不会生效。</li>
</ul>
<h2 id="VirtualXposed-使用说明"><a href="#VirtualXposed-使用说明" class="headerlink" title="VirtualXposed 使用说明"></a>VirtualXposed 使用说明</h2><p>1 进入VirtualXposed主界面如下，可通过右下角标红处进行应用的导出删除以及重启虚拟机等操作。(PS-部分手机可以设置隐藏底部栏，可以通过设置-&gt;导航键样式)</p>
<p><img src="http://pwtn8sf4b.bkt.clouddn.com/v_home.jpeg" alt="home"></p>
<p>2 批量导入删除应用</p>
<p><img src="http://pwtn8sf4b.bkt.clouddn.com/v_apps.jpeg" alt="home"></p>
<p>3 应用管理</p>
<p><img src="http://pwtn8sf4b.bkt.clouddn.com/v_edit.jpeg" alt=""></p>
<p>4 set页</p>
<p><img src="http://pwtn8sf4b.bkt.clouddn.com/v_set.jpeg" alt=""></p>
<p>使用virtualxposed整体开发流程就是，开发hook App，之后打包安装到手机，之后导入到virtualxposed虚拟机，之后再xposed innstaller中管理hook应用，之后软重启即可生效，并可以在innstaller查看日志。切记，每次修改后都要重新导入，并软重启才能生效，整体流程比较繁琐。</p>
<h2 id="Hook-函数介绍"><a href="#Hook-函数介绍" class="headerlink" title="Hook 函数介绍"></a>Hook 函数介绍</h2><h3 id="handleLoadPackage"><a href="#handleLoadPackage" class="headerlink" title="handleLoadPackage"></a>handleLoadPackage</h3><p>hook入口LoadPackageParam包括了包名，进程名，类加载器，App信息包括verisonCode，uid等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadPackageParam</span> <span class="keyword">extends</span> <span class="title">XCallback</span>.<span class="title">Param</span> </span>&#123;</span><br><span class="line">	<span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LoadPackageParam</span><span class="params">(CopyOnWriteSortedSet&lt;XC_LoadPackage&gt; callbacks)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(callbacks);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The name of the package being loaded. */</span></span><br><span class="line">	<span class="keyword">public</span> String packageName;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The process in which the package is executed. */</span></span><br><span class="line">	<span class="keyword">public</span> String processName;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The ClassLoader used for this package. */</span></span><br><span class="line">	<span class="keyword">public</span> ClassLoader classLoader;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** More information about the application being loaded. */</span></span><br><span class="line">	<span class="keyword">public</span> ApplicationInfo appInfo;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Set to &#123;<span class="doctag">@code</span> true&#125; if this is the first (and main) application for this process. */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">boolean</span> isFirstApplication;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="XposedHelpers-findAndHookMethod"><a href="#XposedHelpers-findAndHookMethod" class="headerlink" title="XposedHelpers.findAndHookMethod"></a>XposedHelpers.findAndHookMethod</h3><p>XposedHelpers.findAndHookMethod找到对应的类的对应的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Look up a method and hook it. The last argument must be the callback for the hook.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> className The name of the class which implements the method.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader The class loader for resolving the target and parameter classes.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> methodName The target method name.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parameterTypesAndCallback The parameter types of the target method, plus the callback.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NoSuchMethodError In case the method was not found.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ClassNotFoundError In case the target class or one of the parameter types couldn't be resolved.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> An object which can be used to remove the callback again.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> XC_MethodHook.<span class="function">Unhook <span class="title">findAndHookMethod</span><span class="params">(String className, ClassLoader classLoader, String methodName, Object... parameterTypesAndCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> findAndHookMethod(findClass(className, classLoader), methodName, parameterTypesAndCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">XposedHelpers.findAndHookMethod(<span class="string">"xxx"</span>, lpparam.classLoader, <span class="string">"a"</span>, Object.class, lpparam.classLoader.loadClass(<span class="string">"xxx"</span>), String.class, String.class, String.class, HashMap.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        XposedBridge.log(<span class="string">"错误返回前code:"</span> + param.args[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">       Object result = param.getResult(); <span class="comment">// 获取参数</span></span><br><span class="line">       param.setResult(result); <span class="comment">// 设置参数 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</article>

    <div class="pagenator post-pagenator">
    
    
        <a class="extend prev post-prev" href="/2019/08/28/retrofit/">prev</a>
    

    
    <p>last update time 2019-08-27</p>
    
    
        <a class="extend next post-next" href="/2019/08/09/Okio/">next</a>
    
    </div>

    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">
		
			
				
				
				<li>
					<a href="mailto:shenyonghe525@gmail.com" title="email" target="_blank">
					<i class="fa fa-email"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://github.com/sirencode" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
		
	</ul>
</div>
    <div class="copyright">
        <span>
            
            
            
                © ShenYonghe 2016 - 2019
            
        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a href="https://hexo.io">Hexo</a> & <a href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10); 
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>
    </div>
</body>
</html>
