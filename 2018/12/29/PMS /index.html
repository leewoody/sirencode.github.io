<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>PMS [ Diablo ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/iLiKE.css">
    
  
  
  
  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
    <script id="leancloud">
      AV.init({
          appId: "6E5zTbTljdUbVW2WkXPsXGJk-gzGzoHsz",
          appKey: "0vsyDKfNpeSECAI70J794ugv"
      });
    </script>

</head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="/home.png"></img>
        </a>
      </div>
      <div class="menu-right">
        
          
          
          
          
          
          
          <a href="/">Home</a>
        
          
          
          
          
          
          
          <a href="/archives">Archives</a>
        
      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">PMS</h1>
<article class="post markdown-style">
  <h1 id="PMS"><a href="#PMS" class="headerlink" title="PMS"></a>PMS</h1><h2 id="PMS启动安装APP"><a href="#PMS启动安装APP" class="headerlink" title="PMS启动安装APP"></a>PMS启动安装APP</h2><p>Android应用安装的3种方式：</p>
<ul>
<li>1 系统应用安装：开机自动完成，没有安装界面(system/app目录下)。</li>
<li>2 ADB工具安装――没有安装界面。</li>
<li>3 文件点击安装，有安装界面，packageinstaller.apk应用处理安装及卸载过程的界面。</li>
<li>4 应用市场安装，系统自带的市场(有权限的可以没有界面安装，小米，华为。。)</li>
</ul>
<p>安装目录</p>
<ul>
<li>/system/app目录，系统自带的应用程序，root权限才能删除</li>
<li>而系统出厂的apk文件则被放到了 /system 分区下,包括 /system/app，/system/vendor/app，以及 /system/priv-app 等等</li>
<li>/data/app目录，用户安装的目录，安装时把apk文件复制到此目录,以及app所依赖的native library都放在这里。android 6.0之后，此目录下有一个oat文件夹，存放此app第一次运行时由dex2oat生成的此app的oat文件。</li>
<li>/data/data 存放应用程序的数据</li>
<li>/data/dalvik-cache 将apk中的dex文件安装到dalvik-cache目录下(dex文件是dalvik虚拟机的可执行文件,当然，ART–Android Runtime的可执行文件格式为oat，启用ART时，系统会执行dex文件转换至oat文件)</li>
<li>/data/systempackages.xml 记录了系统的permissions，以及每个apk的name,codePath,flags,ts,version,uesrid等信息，这些信息主要通apk的AndroidManifest.xml解析获取，解析完apk后将更新信息写入这个文件并保存到flash，下次开机直接从里面读取相关信息添加到内存相关列表中。当有apk升级，安装或删除时会更新这个文件。</li>
<li>/data/system/package.list 指定了应用的默认存储位置/data/data/com.xxx.xxx。</li>
</ul>
<h3 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h3><p>1 拷贝apk文件到指定目录，用户app会被拷贝到/data/app目录下，而系统app会拷贝到/system/app，而厂商app被拷贝到/system/app，/system/vendor/app，以及 /system/priv-app等等。<br>2 apk解压，拷贝文件创建应用的数据目录：为了加快app的启动速度，apk在安装的时候，会首先将app的可执行文件（dex）拷贝到 /data/dalvik-cache 目录，缓存起来。在/data/data/目录下创建应用程序的数据目录（以应用的包名命名），存放应用的相关数据，如数据库、xml文件、cache、二进制的so动态库等等。<br>3 解析AndroidManifinest.xml文件，提取出这个apk的重要信息写入到packages.xml文件中，这些信息包括：权限、应用包名、APK的安装位置、版本、userID等等。<br>4 显示快捷方式：还需要有一个Home应用程序，负责从PackageManagerService服务中把这些安装好的应用程序取出来，并以友好的方式在桌面上展现出来，例如以快捷图标的形式。在Android系统中，负责把系统中已经安装的应用程序在桌面中展现出来的Home应用程序就是Launcher了。</p>
<p>APK卸载：将APK文件、data/data/pacakgeName/、dalvik-cache目录中相应的文件删除;并更新PMS中相应的数据结构。</p>
<h4 id="将APK安装文件转移到PMS"><a href="#将APK安装文件转移到PMS" class="headerlink" title="将APK安装文件转移到PMS"></a>将APK安装文件转移到PMS</h4><p>1 首先唤起安装界面PackageInstallerActivity,PackageInstallerActivity主要是检查各种权限，展示被安装应用的向相关信息，最后跳转到实际安装应用的InstallInstalling。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (v == mOk) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mOk.isEnabled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mOkCanInstall || mScrollView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mSessionId != -<span class="number">1</span>) &#123;</span><br><span class="line">                    mInstaller.setPermissionsResult(mSessionId, <span class="keyword">true</span>);</span><br><span class="line">                    finish();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    startInstall();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mScrollView.pageScroll(View.FOCUS_DOWN);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v == mCancel) &#123;</span><br><span class="line">        <span class="comment">// Cancel and finish</span></span><br><span class="line">        setResult(RESULT_CANCELED);</span><br><span class="line">        <span class="keyword">if</span> (mSessionId != -<span class="number">1</span>) &#123;</span><br><span class="line">            mInstaller.setPermissionsResult(mSessionId, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startInstall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Start subactivity to actually install the application</span></span><br><span class="line">    Intent newIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">    newIntent.putExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO,</span><br><span class="line">            mPkgInfo.applicationInfo);</span><br><span class="line">    newIntent.setData(mPackageURI);</span><br><span class="line">    newIntent.setClass(<span class="keyword">this</span>, InstallInstalling.class);</span><br><span class="line">    String installerPackageName = getIntent().getStringExtra(</span><br><span class="line">            Intent.EXTRA_INSTALLER_PACKAGE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (mOriginatingURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_ORIGINATING_URI, mOriginatingURI);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mReferrerURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_REFERRER, mReferrerURI);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mOriginatingUid != PackageInstaller.SessionParams.UID_UNKNOWN) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_ORIGINATING_UID, mOriginatingUid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (installerPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME,</span><br><span class="line">                installerPackageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getIntent().getBooleanExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    newIntent.addFlags(Intent.FLAG_ACTIVITY_FORWARD_RESULT);</span><br><span class="line">    <span class="keyword">if</span>(localLOGV) Log.i(TAG, <span class="string">"downloaded app uri="</span>+mPackageURI);</span><br><span class="line">    startActivity(newIntent);</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 InstallInstalling：发送报信息给PMS，并等待安装结果返回，显示成功或失败的界面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//InstallingAsyncTask</span></span><br><span class="line"><span class="comment">// 根据包(APK)的Uri，将APK的信息通过IO流的形式写入到PackageInstaller.Session中</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> PackageInstaller.<span class="function">Session <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">    PackageInstaller.Session session;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        session = getPackageManager().getPackageInstaller().openSession(mSessionId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    session.setStagingProgress(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(mPackageURI.getPath());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (InputStream in = <span class="keyword">new</span> FileInputStream(file)) &#123;</span><br><span class="line">            <span class="keyword">long</span> sizeBytes = file.length();</span><br><span class="line">            <span class="keyword">try</span> (OutputStream out = session</span><br><span class="line">                    .openWrite(<span class="string">"PackageInstaller"</span>, <span class="number">0</span>, sizeBytes)) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> numRead = in.read(buffer);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (numRead == -<span class="number">1</span>) &#123;</span><br><span class="line">                        session.fsync(out);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">                        session.close();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, numRead);</span><br><span class="line">                    <span class="keyword">if</span> (sizeBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">float</span> fraction = ((<span class="keyword">float</span>) numRead / (<span class="keyword">float</span>) sizeBytes);</span><br><span class="line">                        session.addProgress(fraction);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | SecurityException e) &#123;</span><br><span class="line">        Log.e(LOG_TAG, <span class="string">"Could not write package"</span>, e);</span><br><span class="line"></span><br><span class="line">        session.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            isDone = <span class="keyword">true</span>;</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行session.commit</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(PackageInstaller.Session session)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Intent broadcastIntent = <span class="keyword">new</span> Intent(BROADCAST_ACTION);</span><br><span class="line">        broadcastIntent.setFlags(Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">        broadcastIntent.setPackage(</span><br><span class="line">                getPackageManager().getPermissionControllerPackageName());</span><br><span class="line">        broadcastIntent.putExtra(EventResultPersister.EXTRA_ID, mInstallId);</span><br><span class="line"></span><br><span class="line">        PendingIntent pendingIntent = PendingIntent.getBroadcast(</span><br><span class="line">                InstallInstalling.<span class="keyword">this</span>,</span><br><span class="line">                mInstallId,</span><br><span class="line">                broadcastIntent,</span><br><span class="line">                PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line"></span><br><span class="line">        session.commit(pendingIntent.getIntentSender());</span><br><span class="line">        mCancelButton.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">        setFinishOnTouchOutside(<span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        getPackageManager().getPackageInstaller().abandonSession(mSessionId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isCancelled()) &#123;</span><br><span class="line">            launchFailure(PackageManager.INSTALL_FAILED_INVALID_APK, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3 PackageInstaller.Session.commit-&gt; PackageInstallerSession.commit</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(@NonNull IntentSender statusReceiver, <span class="keyword">boolean</span> forTransfer)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(statusReceiver);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> wasSealed;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        assertCallerIsOwnerOrRootLocked();</span><br><span class="line">        assertPreparedAndNotDestroyedLocked(<span class="string">"commit"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageInstallObserverAdapter adapter = <span class="keyword">new</span> PackageInstallObserverAdapter(</span><br><span class="line">                mContext, statusReceiver, sessionId,</span><br><span class="line">                isInstallerDeviceOwnerOrAffiliatedProfileOwnerLocked(), userId);</span><br><span class="line">        mRemoteObserver = adapter.getBinder();</span><br><span class="line">       ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler.Callback mHandlerCallback = <span class="keyword">new</span> Handler.Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_EARLY_BIND:</span><br><span class="line">                earlyBindToDefContainer();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_COMMIT:</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        commitLocked();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                        <span class="keyword">final</span> String completeMsg = ExceptionUtils.getCompleteMessage(e);</span><br><span class="line">                        Slog.e(TAG,</span><br><span class="line">                                <span class="string">"Commit of session "</span> + sessionId + <span class="string">" failed: "</span> + completeMsg);</span><br><span class="line">                        destroyInternal();</span><br><span class="line">                        dispatchSessionFinished(e.error, completeMsg, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_ON_PACKAGE_INSTALLED:</span><br><span class="line">                <span class="keyword">final</span> SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">                <span class="keyword">final</span> String packageName = (String) args.arg1;</span><br><span class="line">                <span class="keyword">final</span> String message = (String) args.arg2;</span><br><span class="line">                <span class="keyword">final</span> Bundle extras = (Bundle) args.arg3;</span><br><span class="line">                <span class="keyword">final</span> IPackageInstallObserver2 observer = (IPackageInstallObserver2) args.arg4;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> returnCode = args.argi1;</span><br><span class="line">                args.recycle();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    observer.onPackageInstalled(packageName, returnCode, message, extras);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>4 commitLocked 调用PackageManagerService的installStage方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mLock"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitLocked</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mPm.installStage(mPackageName, stageDir, localObserver, params,</span><br><span class="line">            mInstallerPackageName, mInstallerUid, user, mSigningDetails);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="PMS-APK拷贝工作"><a href="#PMS-APK拷贝工作" class="headerlink" title="PMS APK拷贝工作"></a>PMS APK拷贝工作</h4><p>PMS发送INIT_COPY和MCS_BOUND类型的消息，控制PackageHandler来绑定DefaultContainerService，完成复制APK等工作。</p>
<p>1 处理INIT_COPY消息 connectToService方法用来绑定DefaultContainerService</p>
<p>DefaultContainerService是用于检查和复制可移动文件的服务，这是一个比较耗时的操作，因此DefaultContainerService没有和PMS运行在同一进程中，它运行在com.android.defcontainer进程，通过IMediaContainerService和PMS进行IPC通信</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doHandleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">         <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">            HandlerParams params = (HandlerParams) msg.obj;</span><br><span class="line">            <span class="keyword">int</span> idx = mPendingInstalls.size();</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"init_copy idx="</span> + idx + <span class="string">": "</span> + params);</span><br><span class="line">                 <span class="comment">//mBound用于标识是否绑定了服务，默认值为false</span></span><br><span class="line">               <span class="keyword">if</span> (!mBound) &#123;<span class="comment">//1</span></span><br><span class="line">                   Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                      System.identityHashCode(mHandler));</span><br><span class="line">                  <span class="comment">//如果没有绑定服务，重新绑定，connectToService方法内部如果绑定成功会将mBound置为true</span></span><br><span class="line">                  <span class="keyword">if</span> (!connectToService()) &#123;<span class="comment">//2</span></span><br><span class="line">                      Slog.e(TAG, <span class="string">"Failed to bind to media container service"</span>);</span><br><span class="line">                      params.serviceError();</span><br><span class="line">                      Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                                    System.identityHashCode(mHandler));</span><br><span class="line">                     <span class="keyword">if</span> (params.traceMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                         Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, params.traceMethod,</span><br><span class="line">                                        params.traceCookie);</span><br><span class="line">                        &#125;</span><br><span class="line">                            <span class="comment">//绑定服务失败则return</span></span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//绑定服务成功，将请求添加到ArrayList类型的mPendingInstalls中，等待处理</span></span><br><span class="line">                        mPendingInstalls.add(idx, params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//已经绑定服务</span></span><br><span class="line">                      mPendingInstalls.add(idx, params);</span><br><span class="line">                       <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">                          mHandler.sendEmptyMessage(MCS_BOUND);<span class="comment">//3</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>2 MCS_BOUND类型的消息的处理</p>
<p>如果MCS_BOUND类型消息带Object类型的参数就不会满足注释1处的条件，就会调用注释2处的判断，如果安装请求数不大于0就会打印出注释6处的log，说明安装请求队列是空的。安装完一个APK后，就会在注释5处发出MSC_BOUND消息，继续处理剩下的安装请求直到安装请求队列为空。注释3处得到安装请求队列第一个请求HandlerParams ，如果HandlerParams 不为null就会调用注释4处的HandlerParams的startCopy方法，用于开始复制APK的流程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"mcs_bound"</span>);</span><br><span class="line">            <span class="keyword">if</span> (msg.obj != <span class="keyword">null</span>) &#123;<span class="comment">//1</span></span><br><span class="line">                mContainerService = (IMediaContainerService) msg.obj;<span class="comment">//2</span></span><br><span class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                        System.identityHashCode(mHandler));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mContainerService == <span class="keyword">null</span>) &#123;<span class="comment">//3</span></span><br><span class="line">                <span class="keyword">if</span> (!mBound) &#123;<span class="comment">//4</span></span><br><span class="line">                      Slog.e(TAG, <span class="string">"Cannot bind to media container service"</span>);</span><br><span class="line">                      <span class="keyword">for</span> (HandlerParams params : mPendingInstalls) &#123;</span><br><span class="line">                          params.serviceError();<span class="comment">//5</span></span><br><span class="line">                          Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">                                        System.identityHashCode(params));</span><br><span class="line">                          <span class="keyword">if</span> (params.traceMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                          Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER,</span><br><span class="line">                           params.traceMethod, params.traceCookie);</span><br><span class="line">                          &#125;</span><br><span class="line">                          <span class="keyword">return</span>;</span><br><span class="line">                      &#125;   </span><br><span class="line">                          <span class="comment">//绑定失败，清空安装请求队列</span></span><br><span class="line">                          mPendingInstalls.clear();</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                          <span class="comment">//继续等待绑定服务</span></span><br><span class="line">                          Slog.w(TAG, <span class="string">"Waiting to connect to media container service"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              ...</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                   Slog.w(TAG, <span class="string">"Empty queue"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>3 HandlerParams.startCopy</p>
<p>mRetries用于记录startCopy方法调用的次数，调用startCopy方法时会先自动加1，如果次数大于4次就放弃这个安装请求。送MCS_GIVE_UP类型消息，将第一个安装请求（本次安装请求）从安装请求队列mPendingInstalls中移除掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> res;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"startCopy "</span> + mUser + <span class="string">": "</span> + <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//startCopy方法尝试的次数，超过了4次，就放弃这个安装请求</span></span><br><span class="line">        <span class="keyword">if</span> (++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to invoke remote methods on default container service. Giving up"</span>);</span><br><span class="line">            mHandler.sendEmptyMessage(MCS_GIVE_UP);</span><br><span class="line">            handleServiceError();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handleStartCopy();</span><br><span class="line">            res = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Posting install MCS_RECONNECT"</span>);</span><br><span class="line">        mHandler.sendEmptyMessage(MCS_RECONNECT);</span><br><span class="line">        res = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    handleReturnCode();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4 handleStartCopy，它的实现在InstallParams中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//确定APK的安装位置。onSd：安装到SD卡， onInt：内部存储即Data分区，ephemeral：安装到临时存储（Instant Apps安装）            </span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> onSd = (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> onInt = (installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> ephemeral = (installFlags &amp; PackageManager.INSTALL_INSTANT_APP) != <span class="number">0</span>;</span><br><span class="line">            PackageInfoLite pkgLite = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (onInt &amp;&amp; onSd) &#123;</span><br><span class="line">              <span class="comment">// APK不能同时安装在SD卡和Data分区</span></span><br><span class="line">                Slog.w(TAG, <span class="string">"Conflicting flags specified for installing on both internal and external"</span>);</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">              <span class="comment">//安装标志冲突，Instant Apps不能安装到SD卡中</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onSd &amp;&amp; ephemeral) &#123;</span><br><span class="line">                Slog.w(TAG,  <span class="string">"Conflicting flags specified for installing ephemeral on external"</span>);</span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="comment">//获取APK的少量的信息</span></span><br><span class="line">                pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath, installFlags,</span><br><span class="line">                        packageAbiOverride);<span class="comment">//1</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_EPHEMERAL &amp;&amp; ephemeral) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"pkgLite for install: "</span> + pkgLite);</span><br><span class="line">                &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                 <span class="comment">//判断安装的位置</span></span><br><span class="line">                <span class="keyword">int</span> loc = pkgLite.recommendedInstallLocation;</span><br><span class="line">                <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION) &#123;</span><br><span class="line">                    ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_ALREADY_EXISTS) &#123;</span><br><span class="line">                    ret = PackageManager.INSTALL_FAILED_ALREADY_EXISTS;</span><br><span class="line">                &#125; </span><br><span class="line">                ...</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                  loc = installLocationPolicy(pkgLite);<span class="comment">//2</span></span><br><span class="line">                  ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//根据InstallParams创建InstallArgs对象</span></span><br><span class="line">            <span class="keyword">final</span> InstallArgs args = createInstallArgs(<span class="keyword">this</span>);<span class="comment">//3</span></span><br><span class="line">            mArgs = args;</span><br><span class="line">            <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                   ...</span><br><span class="line">                <span class="keyword">if</span> (!origin.existing &amp;&amp; requiredUid != -<span class="number">1</span></span><br><span class="line">                        &amp;&amp; isVerificationEnabled(</span><br><span class="line">                              verifierUser.getIdentifier(), installFlags, installerUid)) &#123;</span><br><span class="line">                      ...</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                    ret = args.copyApk(mContainerService, <span class="keyword">true</span>);<span class="comment">//4</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mRet = ret;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>5 FileInstallArgs copyApk -&gt; doCopyApk</p>
<p>IMediaContainerService跨进程调用DefaultContainerService的copyPackage方法，这个方法会在DefaultContainerService所在的进程中将APK复制到临时存储目录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copyApk</span><span class="params">(IMediaContainerService imcs, <span class="keyword">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"copyApk"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> doCopyApk(imcs, temp);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCopyApk</span><span class="params">(IMediaContainerService imcs, <span class="keyword">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">           ...</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isEphemeral = (installFlags &amp; PackageManager.INSTALL_INSTANT_APP) != <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//创建临时文件存储目录</span></span><br><span class="line">                <span class="keyword">final</span> File tempDir =</span><br><span class="line">                        mInstallerService.allocateStageDirLegacy(volumeUuid, isEphemeral);<span class="comment">//1</span></span><br><span class="line">                codeFile = tempDir;</span><br><span class="line">                resourceFile = tempDir;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed to create copy file: "</span> + e);</span><br><span class="line">                <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">            ret = imcs.copyPackage(origin.file.getAbsolutePath(), target);<span class="comment">//2</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>6 DefaultContainerService 执行apk文件的拷贝</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">copyPackage</span><span class="params">(String packagePath, IParcelFileDescriptorFactory target)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> File packageFile = <span class="keyword">new</span> File(packagePath);</span><br><span class="line">        pkg = PackageParser.parsePackageLite(packageFile, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> copyPackageInner(pkg, target);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException | IOException | RemoteException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to copy package at "</span> + packagePath + <span class="string">": "</span> + e);</span><br><span class="line">        <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">copyPackageInner</span><span class="params">(PackageLite pkg, IParcelFileDescriptorFactory target)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, RemoteException </span>&#123;</span><br><span class="line">    copyFile(pkg.baseCodePath, target, <span class="string">"base.apk"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!ArrayUtils.isEmpty(pkg.splitNames)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pkg.splitNames.length; i++) &#123;</span><br><span class="line">            copyFile(pkg.splitCodePaths[i], target, <span class="string">"split_"</span> + pkg.splitNames[i] + <span class="string">".apk"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(String sourcePath, IParcelFileDescriptorFactory target, String targetName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, RemoteException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> FileInputStream(sourcePath);</span><br><span class="line">        out = <span class="keyword">new</span> ParcelFileDescriptor.AutoCloseOutputStream(</span><br><span class="line">                target.open(targetName, ParcelFileDescriptor.MODE_READ_WRITE));</span><br><span class="line">        FileUtils.copy(in, out);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(out);</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PackageParser-解析器"><a href="#PackageParser-解析器" class="headerlink" title="PackageParser 解析器"></a>PackageParser 解析器</h3><h4 id="Split-APK机制"><a href="#Split-APK机制" class="headerlink" title="Split APK机制"></a>Split APK机制</h4><p>Split APK是Google为解决65536上限，以及APK安装包越来越大等问题，在Android L中引入的机制。Split APK 可以将一个庞大的 APK，按屏幕密度，ABI 等形式拆分成多个独立的 APK，在应用程序更新时，不必下载整个 APK，只需单独下载某个模块即可安装更新。Split APK 将原来一个 APK 中多个模块共享同一份资源的模型分离成多个 APK 使用各自的资源，并且可以继承 Base APK 中的资源，多个 APK 有相同的 data，cache 目录。</p>
<ul>
<li>Single APK：安装文件为一个完整的APK，即base APK。Android称其为Monolithic。</li>
<li>Mutiple APK：安装文件在一个文件目录中，其内部有多个被拆分的APK，这些APK由一个 base APK和一个或多个split APK组成。Android称其为Cluster。</li>
</ul>
<p>1 parsePackage</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags, <span class="keyword">boolean</span> useCaches)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    Package parsed = useCaches ? getCachedResult(packageFile, flags) : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (parsed != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> parsed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> parseTime = LOG_PARSE_TIMINGS ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果解析的packageFile是一个目录，则调用 parseClusterPackage</span></span><br><span class="line">    <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</span><br><span class="line">        parsed = parseClusterPackage(packageFile, flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果是单个APK文件，则调用 parseMonolithicPackage</span></span><br><span class="line">        parsed = parseMonolithicPackage(packageFile, flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> cacheTime = LOG_PARSE_TIMINGS ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">    cacheResult(packageFile, flags, parsed);</span><br><span class="line">    <span class="keyword">if</span> (LOG_PARSE_TIMINGS) &#123;</span><br><span class="line">        parseTime = cacheTime - parseTime;</span><br><span class="line">        cacheTime = SystemClock.uptimeMillis() - cacheTime;</span><br><span class="line">        <span class="keyword">if</span> (parseTime + cacheTime &gt; LOG_PARSE_TIMINGS_THRESHOLD_MS) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Parse times for '"</span> + packageFile + <span class="string">"': parse="</span> + parseTime</span><br><span class="line">                    + <span class="string">"ms, update_cache="</span> + cacheTime + <span class="string">" ms"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> parsed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 parseClusterPackage </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseClusterPackage</span><span class="params">(File packageDir, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="comment">// 之所以要轻量级解析是因为解析APK是一个复杂耗时的操作，这里的逻辑并不需要APK所有的信息。</span></span><br><span class="line">    <span class="keyword">final</span> PackageLite lite = parseClusterPackageLite(packageDir, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mOnlyCoreApps &amp;&amp; !lite.coreApp) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                <span class="string">"Not a coreApp: "</span> + packageDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Build the split dependency tree.</span></span><br><span class="line">    SparseArray&lt;<span class="keyword">int</span>[]&gt; splitDependencies = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> SplitAssetLoader assetLoader;</span><br><span class="line">    <span class="keyword">if</span> (lite.isolatedSplits &amp;&amp; !ArrayUtils.isEmpty(lite.splitNames)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            splitDependencies = SplitAssetDependencyLoader.createDependenciesFromPackage(lite);</span><br><span class="line">            assetLoader = <span class="keyword">new</span> SplitAssetDependencyLoader(lite, splitDependencies, flags);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SplitAssetDependencyLoader.IllegalDependencyException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        assetLoader = <span class="keyword">new</span> DefaultSplitAssetLoader(lite, flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> AssetManager assets = assetLoader.getBaseAssetManager();</span><br><span class="line">        <span class="keyword">final</span> File baseApk = <span class="keyword">new</span> File(lite.baseCodePath);</span><br><span class="line">        <span class="comment">// 解析 base APK</span></span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(baseApk, assets, flags);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                    <span class="string">"Failed to parse base APK: "</span> + baseApk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitNames)) &#123;</span><br><span class="line">            <span class="comment">// 获取 split APK 的数量</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> num = lite.splitNames.length;</span><br><span class="line">            pkg.splitNames = lite.splitNames;</span><br><span class="line">            pkg.splitCodePaths = lite.splitCodePaths;</span><br><span class="line">            pkg.splitRevisionCodes = lite.splitRevisionCodes;</span><br><span class="line">            pkg.splitFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line">            pkg.splitPrivateFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line">            pkg.applicationInfo.splitNames = pkg.splitNames;</span><br><span class="line">            pkg.applicationInfo.splitDependencies = splitDependencies;</span><br><span class="line">            pkg.applicationInfo.splitClassLoaderNames = <span class="keyword">new</span> String[num];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> AssetManager splitAssets = assetLoader.getSplitAssetManager(i);</span><br><span class="line">                <span class="comment">// 解析每个 split APK</span></span><br><span class="line">                parseSplitApk(pkg, i, splitAssets, flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.setCodePath(packageDir.getCanonicalPath());</span><br><span class="line">        pkg.setUse32bitAbi(lite.use32bitAbi);</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">"Failed to get path: "</span> + lite.baseCodePath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(assetLoader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.1 parseClusterPackageLite 解析多个apk为apklite，并将这些apklite封装为一个packelite</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> PackageLite <span class="title">parseClusterPackageLite</span><span class="params">(File packageDir, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isApkFile(file)) &#123;</span><br><span class="line">            <span class="comment">// 通过 parseApkLite 方法解析每个 Mutiple APK，得到每个 Mutiple APK 对应的 ApkLite（轻量级 APK 信息）</span></span><br><span class="line">            <span class="keyword">final</span> ApkLite lite = parseApkLite(file, flags);</span><br><span class="line">            ... ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String codePath = packageDir.getAbsolutePath();</span><br><span class="line">    <span class="comment">// 将这些 ApkLite 封装为一个 PackageLite（轻量级包信息）并返回</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageLite(codePath, baseApk, splitNames, isFeatureSplits, usesSplitNames,</span><br><span class="line">            configForSplits, splitCodePaths, splitRevisionCodes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.2 parseBaseApk</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(File apkFile, AssetManager assets, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    String volumeUuid = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (apkPath.startsWith(MNT_EXPAND)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> end = apkPath.indexOf(<span class="string">'/'</span>, MNT_EXPAND.length());</span><br><span class="line">        <span class="comment">// 如果 APK 的路径以 /mnt/expand/ 开头，就截取该路径获取 volumeUuid</span></span><br><span class="line">        volumeUuid = apkPath.substring(MNT_EXPAND.length(), end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mParseError = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    mArchiveSourcePath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_JAR) Slog.d(TAG, <span class="string">"Scanning base APK: "</span> + apkPath);</span><br><span class="line"></span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cookie = assets.findCookieForPath(apkPath);</span><br><span class="line">        <span class="keyword">if</span> (cookie == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                    <span class="string">"Failed adding asset path: "</span> + apkPath);</span><br><span class="line">        &#125;</span><br><span class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line">        <span class="keyword">final</span> Resources res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String[] outError = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 再次调用 parseBaseApk 方法</span></span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(apkPath, res, parser, flags, outError);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(mParseError,</span><br><span class="line">                    apkPath + <span class="string">" (at "</span> + parser.getPositionDescription() + <span class="string">"): "</span> + outError[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.setVolumeUuid(volumeUuid);</span><br><span class="line">        pkg.setApplicationVolumeUuid(volumeUuid);</span><br><span class="line">        pkg.setBaseCodePath(apkPath);</span><br><span class="line">        pkg.setSigningDetails(SigningDetails.UNKNOWN);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">"Failed to read manifest from "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(String apkPath, Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String splitName;</span><br><span class="line">    <span class="keyword">final</span> String pkgName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, parser);</span><br><span class="line">        pkgName = packageSplit.first;</span><br><span class="line">        splitName = packageSplit.second;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(splitName)) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Expected base APK, but found split "</span> + splitName;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String[] overlayPaths = mCallback.getOverlayPaths(pkgName, apkPath);</span><br><span class="line">        <span class="keyword">if</span> (overlayPaths != <span class="keyword">null</span> &amp;&amp; overlayPaths.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String overlayPath : overlayPaths) &#123;</span><br><span class="line">                res.getAssets().addOverlayPath(overlayPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Package pkg = <span class="keyword">new</span> Package(pkgName);</span><br><span class="line">    <span class="comment">//从资源中提取自定义属性集 com.android.internal.R.styleable.AndroidManifest 得到 TypedArray</span></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest);</span><br><span class="line">    <span class="comment">// 使用 typedarray 获取 AndroidManifest 中的 versionCode 赋值给 Package 的对应属性</span></span><br><span class="line">    pkg.mVersionCode = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_versionCode, <span class="number">0</span>);</span><br><span class="line">    pkg.mVersionCodeMajor = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_versionCodeMajor, <span class="number">0</span>);</span><br><span class="line">    pkg.applicationInfo.setVersionCode(pkg.getLongVersionCode());</span><br><span class="line">    pkg.baseRevisionCode = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_revisionCode, <span class="number">0</span>);</span><br><span class="line">    pkg.mVersionName = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_versionName, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pkg.mVersionName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pkg.mVersionName = pkg.mVersionName.intern();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取 APK 的 AndroidManifest 中的 coreApp 的值</span></span><br><span class="line">    pkg.coreApp = parser.getAttributeBooleanValue(<span class="keyword">null</span>, <span class="string">"coreApp"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    pkg.mCompileSdkVersion = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_compileSdkVersion, <span class="number">0</span>);</span><br><span class="line">    pkg.applicationInfo.compileSdkVersion = pkg.mCompileSdkVersion;</span><br><span class="line">    pkg.mCompileSdkVersionCodename = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_compileSdkVersionCodename, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pkg.mCompileSdkVersionCodename != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pkg.mCompileSdkVersionCodename = pkg.mCompileSdkVersionCodename.intern();</span><br><span class="line">    &#125;</span><br><span class="line">    pkg.applicationInfo.compileSdkVersionCodename = pkg.mCompileSdkVersionCodename;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> parseBaseApkCommon(pkg, <span class="keyword">null</span>, res, parser, flags, outError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.2.1 parseBaseApkCommon xml解析AndroidManifest.xml文件，获取权限，四大组件等信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApkCommon</span><span class="params">(Package pkg, Set&lt;String&gt; acceptedTags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 解析application标签</span></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_APPLICATION)) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, flags, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION)) &#123;</span><br><span class="line">            <span class="comment">// 解析权限</span></span><br><span class="line">            <span class="keyword">if</span> (!parsePermission(pkg, res, parser, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_TREE)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!parsePermissionTree(pkg, res, parser, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.2.2 parseBaseApplication 解析application标签</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parseBaseApplication 方法很长，我们这里只截取了解析四大组件相关的代码。</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">            XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">        ... ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</span><br><span class="line">                <span class="comment">// 调用 parseActivity 方法解析 activity 标签并得到一个 Activity 对象（PackageParser 的静态内部类）</span></span><br><span class="line">                Activity a = parseActivity(owner, res, parser, flags, outError, cachedArgs, <span class="keyword">false</span>,</span><br><span class="line">                        owner.baseHardwareAccelerated);</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hasActivityOrder |= (a.order != <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 将解析得到的 Activity 对象保存在 Package 的列表 activities 中</span></span><br><span class="line">                owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123;</span><br><span class="line">                Activity a = parseActivity(owner, res, parser, flags, outError, cachedArgs,</span><br><span class="line">                        <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hasReceiverOrder |= (a.order != <span class="number">0</span>);</span><br><span class="line">                owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123;</span><br><span class="line">                Service s = parseService(owner, res, parser, flags, outError, cachedArgs);</span><br><span class="line">                <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hasServiceOrder |= (s.order != <span class="number">0</span>);</span><br><span class="line">                owner.services.add(s);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;</span><br><span class="line">                Provider p = parseProvider(owner, res, parser, flags, outError, cachedArgs);</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                owner.providers.add(p);</span><br><span class="line">            &#125;</span><br><span class="line">            ... ...</span><br><span class="line">        &#125;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>2.2.3 parsePermission解析记录权限信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parsePermission</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission);</span><br><span class="line"></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">    <span class="comment">// that may change.</span></span><br><span class="line">    perm.info.group = sa.getNonResourceString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (perm.info.group != <span class="keyword">null</span>) &#123;</span><br><span class="line">        perm.info.group = perm.info.group.intern();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_description,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    perm.info.requestRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_request, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    perm.info.protectionLevel = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_protectionLevel,</span><br><span class="line">            PermissionInfo.PROTECTION_NORMAL);</span><br><span class="line"></span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (perm.info.protectionLevel == -<span class="number">1</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt; does not specify protectionLevel"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.fixProtectionLevel(perm.info.protectionLevel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (perm.info.getProtectionFlags() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (perm.info.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_INSTANT) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (perm.info.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_RUNTIME_ONLY) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (perm.info.protectionLevel&amp;PermissionInfo.PROTECTION_MASK_BASE) !=</span><br><span class="line">                PermissionInfo.PROTECTION_SIGNATURE) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt;  protectionLevel specifies a non-instant flag but is "</span></span><br><span class="line">                    + <span class="string">"not based on signature type"</span>;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission&gt;"</span>, perm, outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article>

    <div class="pagenator post-pagenator">
    
    
        <a class="extend prev post-prev" href="/2019/02/21/Trust Zone/">prev</a>
    

    
    <p>last update time 2018-12-29</p>
    
    
        <a class="extend next post-next" href="/2018/12/21/通知/">next</a>
    
    </div>

    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">
		
			
				
				
				<li>
					<a href="mailto:shenyonghe525@gmail.com" title="email" target="_blank">
					<i class="fa fa-email"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://github.com/sirencode" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
		
	</ul>
</div>
    <div class="copyright">
        <span>
            
            
            
                © ShenYonghe 2016 - 2019
            
        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a href="https://hexo.io">Hexo</a> & <a href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10); 
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>
    </div>
</body>
</html>
