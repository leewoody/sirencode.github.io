<!DOCTYPE html>

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>Notification详解 [ Diablo ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/iLiKE.css">
    
  
  
  
  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
    <script id="leancloud">
      AV.init({
          appId: "6E5zTbTljdUbVW2WkXPsXGJk-gzGzoHsz",
          appKey: "0vsyDKfNpeSECAI70J794ugv"
      });
    </script>

</head>
<body>
    <div class="header">
        <div class="container">
    <div class="menu">
      <div class="menu-left">
        <a href="/">
          <img src="/home.png"></img>
        </a>
      </div>
      <div class="menu-right">
        
          
          
          
          
          
          
          <a href="/">トップページ</a>
        
          
          
          
          
          
          
          <a href="/archives">ポスト</a>
        
      </div>
    </div>
</div>
    </div>
    <div class="container">
        <h1 class="post-title">Notification详解</h1>
<article class="post markdown-style">
  <h1 id="通知"><a href="#通知" class="headerlink" title="通知"></a>通知</h1><h2 id="Notification"><a href="#Notification" class="headerlink" title="Notification"></a>Notification</h2><p>Notification是消息的数据实体类，包含了消息的具体信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Notification</span> <span class="keyword">implements</span> <span class="title">Parcelable</span></span></span><br></pre></td></tr></table></figure>
<h2 id="NotificationManager"><a href="#NotificationManager" class="headerlink" title="NotificationManager"></a>NotificationManager</h2><p>NotificationManager 是通知管理类，它是一个系统服务。调用 NotificationManager 的 notify() 方法可以向系统发送通知。</p>
<p>必须添加的属性：</p>
<ul>
<li>小图标，通过setSmallIcon() 方法设置</li>
<li>标题，通过setContentTitle() 方法设置</li>
<li>内容，通过setContentText() 方法设置</li>
</ul>
<h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h3><p>1 NM发送消息，其中id必须设置，而tag可选，最终调用notifyAsUser。getService()通过Binder获取到NotificationManager对应的Service NMS</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(<span class="keyword">int</span> id, Notification notification)</span> </span>&#123;</span><br><span class="line">    notify(<span class="keyword">null</span>, id, notification);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(String tag, <span class="keyword">int</span> id, Notification notification)</span> </span>&#123;</span><br><span class="line">    notifyAsUser(tag, id, notification, mContext.getUser());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyAsUser</span><span class="params">(String tag, <span class="keyword">int</span> id, Notification notification, UserHandle user)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取NMS</span></span><br><span class="line">    INotificationManager service = getService();</span><br><span class="line">    String pkg = mContext.getPackageName();</span><br><span class="line">    <span class="comment">// Fix the notification as best we can.</span></span><br><span class="line">    <span class="comment">// 将应用信息和用户id添加到Notification</span></span><br><span class="line">    Notification.addFieldsFromContext(mContext, notification);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (notification.sound != <span class="keyword">null</span>) &#123;</span><br><span class="line">        notification.sound = notification.sound.getCanonicalUri();</span><br><span class="line">        <span class="keyword">if</span> (StrictMode.vmFileUriExposureEnabled()) &#123;</span><br><span class="line">            notification.sound.checkFileUriExposed(<span class="string">"Notification.sound"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 修复一些icon问题,如果没有就给他指定一个</span></span><br><span class="line">    fixLegacySmallIcon(notification, pkg);</span><br><span class="line">    <span class="keyword">if</span> (mContext.getApplicationInfo().targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (notification.getSmallIcon() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid notification (no valid small icon): "</span></span><br><span class="line">                    + notification);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (localLOGV) Log.v(TAG, pkg + <span class="string">": notify("</span> + id + <span class="string">", "</span> + notification + <span class="string">")"</span>);</span><br><span class="line">    notification.reduceImageSizes(mContext);</span><br><span class="line"></span><br><span class="line">    ActivityManager am = (ActivityManager) mContext.getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">    <span class="keyword">boolean</span> isLowRam = am.isLowRamDevice();</span><br><span class="line">    <span class="keyword">final</span> Notification copy = Builder.maybeCloneStrippedForDelivery(notification, isLowRam,</span><br><span class="line">            mContext);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        service.enqueueNotificationWithTag(pkg, mContext.getOpPackageName(), tag, id,</span><br><span class="line">                copy, user.getIdentifier());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 NMS enqueueNotificationWithTag-&gt;enqueueNotificationInternal</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueNotificationInternal</span><span class="params">(<span class="keyword">final</span> String pkg, <span class="keyword">final</span> String opPkg, <span class="keyword">final</span> <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> callingPid, <span class="keyword">final</span> String tag, <span class="keyword">final</span> <span class="keyword">int</span> id, <span class="keyword">final</span> Notification notification,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> incomingUserId)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 检查是否是同一个app发出的，或者系统发出的，否则抛出异常</span></span><br><span class="line">    checkCallerIsSystemOrSameApp(pkg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = ActivityManager.handleIncomingUser(callingPid,</span><br><span class="line">            callingUid, incomingUserId, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"enqueueNotification"</span>, pkg);</span><br><span class="line">    <span class="keyword">final</span> UserHandle user = <span class="keyword">new</span> UserHandle(userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span> || notification == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null not allowed: pkg="</span> + pkg</span><br><span class="line">                + <span class="string">" id="</span> + id + <span class="string">" notification="</span> + notification);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The system can post notifications for any package, let us resolve that.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> notificationUid = resolveNotificationUid(opPkg, callingUid, userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fix the notification as best we can.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> ApplicationInfo ai = mPackageManagerClient.getApplicationInfoAsUser(</span><br><span class="line">                pkg, PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                (userId == UserHandle.USER_ALL) ? USER_SYSTEM : userId);</span><br><span class="line">        Notification.addFieldsFromContext(ai, notification);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> canColorize = mPackageManagerClient.checkPermission(</span><br><span class="line">                android.Manifest.permission.USE_COLORIZED_NOTIFICATIONS, pkg);</span><br><span class="line">        <span class="keyword">if</span> (canColorize == PERMISSION_GRANTED) &#123;</span><br><span class="line">            notification.flags |= Notification.FLAG_CAN_COLORIZE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            notification.flags &amp;= ~Notification.FLAG_CAN_COLORIZE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Cannot create a context for sending app"</span>, e);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mUsageStats.registerEnqueuedByApp(pkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup local book-keeping</span></span><br><span class="line">    String channelId = notification.getChannelId();</span><br><span class="line">    <span class="keyword">if</span> (mIsTelevision &amp;&amp; (<span class="keyword">new</span> Notification.TvExtender(notification)).getChannelId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        channelId = (<span class="keyword">new</span> Notification.TvExtender(notification)).getChannelId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> NotificationChannel channel = mRankingHelper.getNotificationChannel(pkg,</span><br><span class="line">            notificationUid, channelId, <span class="keyword">false</span> <span class="comment">/* includeDeleted */</span>);</span><br><span class="line">    <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> String noChannelStr = <span class="string">"No Channel found for "</span></span><br><span class="line">                + <span class="string">"pkg="</span> + pkg</span><br><span class="line">                + <span class="string">", channelId="</span> + channelId</span><br><span class="line">                + <span class="string">", id="</span> + id</span><br><span class="line">                + <span class="string">", tag="</span> + tag</span><br><span class="line">                + <span class="string">", opPkg="</span> + opPkg</span><br><span class="line">                + <span class="string">", callingUid="</span> + callingUid</span><br><span class="line">                + <span class="string">", userId="</span> + userId</span><br><span class="line">                + <span class="string">", incomingUserId="</span> + incomingUserId</span><br><span class="line">                + <span class="string">", notificationUid="</span> + notificationUid</span><br><span class="line">                + <span class="string">", notification="</span> + notification;</span><br><span class="line">        Log.e(TAG, noChannelStr);</span><br><span class="line">        <span class="keyword">boolean</span> appNotificationsOff = mRankingHelper.getImportance(pkg, notificationUid)</span><br><span class="line">                == NotificationManager.IMPORTANCE_NONE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!appNotificationsOff) &#123;</span><br><span class="line">            doChannelWarningToast(<span class="string">"Developer warning for package \""</span> + pkg + <span class="string">"\"\n"</span> +</span><br><span class="line">                    <span class="string">"Failed to post notification on channel \""</span> + channelId + <span class="string">"\"\n"</span> +</span><br><span class="line">                    <span class="string">"See log for more details"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将一个Notification封装成成一个StatusBarNotification</span></span><br><span class="line">    <span class="keyword">final</span> StatusBarNotification n = <span class="keyword">new</span> StatusBarNotification(</span><br><span class="line">            pkg, opPkg, id, tag, notificationUid, callingPid, notification,</span><br><span class="line">            user, <span class="keyword">null</span>, System.currentTimeMillis());</span><br><span class="line">    <span class="keyword">final</span> NotificationRecord r = <span class="keyword">new</span> NotificationRecord(getContext(), n, channel);</span><br><span class="line">    r.setIsAppImportanceLocked(mRankingHelper.getIsAppImportanceLocked(pkg, callingUid));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((notification.flags &amp; Notification.FLAG_FOREGROUND_SERVICE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> fgServiceShown = channel.isFgServiceShown();</span><br><span class="line">        <span class="keyword">if</span> (((channel.getUserLockedFields() &amp; NotificationChannel.USER_LOCKED_IMPORTANCE) == <span class="number">0</span></span><br><span class="line">                    || !fgServiceShown)</span><br><span class="line">                &amp;&amp; (r.getImportance() == IMPORTANCE_MIN</span><br><span class="line">                        || r.getImportance() == IMPORTANCE_NONE)) &#123;</span><br><span class="line">            <span class="comment">// Increase the importance of foreground service notifications unless the user had</span></span><br><span class="line">            <span class="comment">// an opinion otherwise (and the channel hasn't yet shown a fg service).</span></span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(channelId)</span><br><span class="line">                    || NotificationChannel.DEFAULT_CHANNEL_ID.equals(channelId)) &#123;</span><br><span class="line">                r.setImportance(IMPORTANCE_LOW, <span class="string">"Bumped for foreground service"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                channel.setImportance(IMPORTANCE_LOW);</span><br><span class="line">                <span class="keyword">if</span> (!fgServiceShown) &#123;</span><br><span class="line">                    channel.unlockFields(NotificationChannel.USER_LOCKED_IMPORTANCE);</span><br><span class="line">                    channel.setFgServiceShown(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mRankingHelper.updateNotificationChannel(pkg, notificationUid, channel, <span class="keyword">false</span>);</span><br><span class="line">                r.updateNotificationChannel(channel);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!fgServiceShown &amp;&amp; !TextUtils.isEmpty(channelId)</span><br><span class="line">                &amp;&amp; !NotificationChannel.DEFAULT_CHANNEL_ID.equals(channelId)) &#123;</span><br><span class="line">            channel.setFgServiceShown(<span class="keyword">true</span>);</span><br><span class="line">            r.updateNotificationChannel(channel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!checkDisqualifyingFeatures(userId, notificationUid, id, tag, r,</span><br><span class="line">            r.sbn.getOverrideGroupKey() != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Whitelist pending intents.</span></span><br><span class="line">    <span class="keyword">if</span> (notification.allPendingIntents != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> intentCount = notification.allPendingIntents.size();</span><br><span class="line">        <span class="keyword">if</span> (intentCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityManagerInternal am = LocalServices</span><br><span class="line">                    .getService(ActivityManagerInternal.class);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> duration = LocalServices.getService(</span><br><span class="line">                    DeviceIdleController.LocalService.class).getNotificationWhitelistDuration();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; intentCount; i++) &#123;</span><br><span class="line">                PendingIntent pendingIntent = notification.allPendingIntents.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (pendingIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    am.setPendingIntentWhitelistDuration(pendingIntent.getTarget(),</span><br><span class="line">                            WHITELIST_TOKEN, duration);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mHandler.post(<span class="keyword">new</span> EnqueueNotificationRunnable(userId, r));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3 handler.post( EnqueueNotificationRunnable run)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mNotificationLock) &#123;</span><br><span class="line">        mEnqueuedNotifications.add(r);</span><br><span class="line">        scheduleTimeoutLocked(r);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> StatusBarNotification n = r.sbn;</span><br><span class="line">        <span class="keyword">if</span> (DBG) Slog.d(TAG, <span class="string">"EnqueueNotificationRunnable.run for: "</span> + n.getKey());</span><br><span class="line">        NotificationRecord old = mNotificationsByKey.get(n.getKey());</span><br><span class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Retain ranking information from previous record</span></span><br><span class="line">            r.copyRankingInformation(old);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = n.getUid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingPid = n.getInitialPid();</span><br><span class="line">        <span class="keyword">final</span> Notification notification = n.getNotification();</span><br><span class="line">        <span class="keyword">final</span> String pkg = n.getPackageName();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> id = n.getId();</span><br><span class="line">        <span class="keyword">final</span> String tag = n.getTag();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle grouped notifications and bail out early if we</span></span><br><span class="line">        <span class="comment">// can to avoid extracting signals.</span></span><br><span class="line">        <span class="comment">// Notification以群组的方式显示, 就是Android N的Bundled notifications</span></span><br><span class="line">        handleGroupedNotificationLocked(r, old, callingUid, callingPid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if this is a group child, unsnooze parent summary</span></span><br><span class="line">        <span class="keyword">if</span> (n.isGroup() &amp;&amp; notification.isGroupChild()) &#123;</span><br><span class="line">            mSnoozeHelper.repostGroupSummary(pkg, r.getUserId(), n.getGroupKey());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This conditional is a dirty hack to limit the logging done on</span></span><br><span class="line">        <span class="comment">//     behalf of the download manager without affecting other apps.</span></span><br><span class="line">        <span class="keyword">if</span> (!pkg.equals(<span class="string">"com.android.providers.downloads"</span>)</span><br><span class="line">                || Log.isLoggable(<span class="string">"DownloadManager"</span>, Log.VERBOSE)) &#123;</span><br><span class="line">            <span class="keyword">int</span> enqueueStatus = EVENTLOG_ENQUEUE_STATUS_NEW;</span><br><span class="line">            <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">                enqueueStatus = EVENTLOG_ENQUEUE_STATUS_UPDATE;</span><br><span class="line">            &#125;</span><br><span class="line">            EventLogTags.writeNotificationEnqueue(callingUid, callingPid,</span><br><span class="line">                    pkg, id, tag, userId, notification.toString(),</span><br><span class="line">                    enqueueStatus);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mRankingHelper.extractSignals(r);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tell the assistant service about the notification</span></span><br><span class="line">        <span class="keyword">if</span> (mAssistants.isEnabled()) &#123;</span><br><span class="line">            mAssistants.onNotificationEnqueued(r);</span><br><span class="line">            mHandler.postDelayed(<span class="keyword">new</span> PostNotificationRunnable(r.getKey()),</span><br><span class="line">                    DELAY_FOR_ASSISTANT_TIME);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mHandler.post(<span class="keyword">new</span> PostNotificationRunnable(r.getKey()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>4 handler.post(PostNotificationRunnable run)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mNotificationLock) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            NotificationRecord r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> N = mEnqueuedNotifications.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> NotificationRecord enqueued = mEnqueuedNotifications.get(i);</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(key, enqueued.getKey())) &#123;</span><br><span class="line">                    r = enqueued;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Cannot find enqueued record for key: "</span> + key);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r.setHidden(isPackageSuspendedLocked(r));</span><br><span class="line">            NotificationRecord old = mNotificationsByKey.get(key);</span><br><span class="line">            <span class="keyword">final</span> StatusBarNotification n = r.sbn;</span><br><span class="line">            <span class="keyword">final</span> Notification notification = n.getNotification();</span><br><span class="line">            <span class="keyword">int</span> index = indexOfNotificationLocked(n.getKey());</span><br><span class="line">            <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                mNotificationList.add(r);</span><br><span class="line">                mUsageStats.registerPostedByApp(r);</span><br><span class="line">                r.setInterruptive(isVisuallyInterruptive(<span class="keyword">null</span>, r));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                old = mNotificationList.get(index);</span><br><span class="line">                mNotificationList.set(index, r);</span><br><span class="line">                mUsageStats.registerUpdatedByApp(r, old);</span><br><span class="line">                <span class="comment">// Make sure we don't lose the foreground service state.</span></span><br><span class="line">                notification.flags |=</span><br><span class="line">                        old.getNotification().flags &amp; FLAG_FOREGROUND_SERVICE;</span><br><span class="line">                r.isUpdate = <span class="keyword">true</span>;</span><br><span class="line">                r.setTextChanged(isVisuallyInterruptive(old, r));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mNotificationsByKey.put(n.getKey(), r);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ensure if this is a foreground service that the proper additional</span></span><br><span class="line">            <span class="comment">// flags are set.</span></span><br><span class="line">            <span class="keyword">if</span> ((notification.flags &amp; FLAG_FOREGROUND_SERVICE) != <span class="number">0</span>) &#123;</span><br><span class="line">                notification.flags |= Notification.FLAG_ONGOING_EVENT</span><br><span class="line">                        | Notification.FLAG_NO_CLEAR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            applyZenModeLocked(r);</span><br><span class="line">            mRankingHelper.sort(mNotificationList);</span><br><span class="line">            <span class="comment">// 没有设置smallicon会报错</span></span><br><span class="line">            <span class="keyword">if</span> (notification.getSmallIcon() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                StatusBarNotification oldSbn = (old != <span class="keyword">null</span>) ? old.sbn : <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// 通知所有者</span></span><br><span class="line">                mListeners.notifyPostedLocked(r, old);</span><br><span class="line">                <span class="keyword">if</span> (oldSbn == <span class="keyword">null</span> || !Objects.equals(oldSbn.getGroup(), n.getGroup())) &#123;</span><br><span class="line">                    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            mGroupHelper.onNotificationPosted(</span><br><span class="line">                                    n, hasAutoGroupSummaryLocked(n));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Not posting notification without small icon: "</span> + notification);</span><br><span class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; !old.isCanceled) &#123;</span><br><span class="line">                    mListeners.notifyRemovedLocked(r,</span><br><span class="line">                            NotificationListenerService.REASON_ERROR, <span class="keyword">null</span>);</span><br><span class="line">                    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            mGroupHelper.onNotificationRemoved(n);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ATTENTION: in a future release we will bail out here</span></span><br><span class="line">                <span class="comment">// so that we do not play sounds, show lights, etc. for invalid</span></span><br><span class="line">                <span class="comment">// notifications</span></span><br><span class="line">                Slog.e(TAG, <span class="string">"WARNING: In a future release this will crash the app: "</span></span><br><span class="line">                        + n.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!r.isHidden()) &#123;</span><br><span class="line">                buzzBeepBlinkLocked(r);</span><br><span class="line">            &#125;</span><br><span class="line">            maybeRecordInterruptionLocked(r);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> N = mEnqueuedNotifications.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> NotificationRecord enqueued = mEnqueuedNotifications.get(i);</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(key, enqueued.getKey())) &#123;</span><br><span class="line">                    mEnqueuedNotifications.remove(i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>5 NotificationManagerService.NotificationListeners notifyPostedLocked</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mNotificationLock"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyPostedLocked</span><span class="params">(NotificationRecord r, NotificationRecord old,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> notifyAllListeners)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Lazily initialized snapshots of the notification.</span></span><br><span class="line">    StatusBarNotification sbn = r.sbn;</span><br><span class="line">    StatusBarNotification oldSbn = (old != <span class="keyword">null</span>) ? old.sbn : <span class="keyword">null</span>;</span><br><span class="line">    TrimCache trimCache = <span class="keyword">new</span> TrimCache(sbn);</span><br><span class="line">    <span class="comment">// for循环方式，跨进程,通知到每一个INotificationLister</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> ManagedServiceInfo info : getServices()) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> sbnVisible = isVisibleToListener(sbn, info);</span><br><span class="line">        <span class="keyword">boolean</span> oldSbnVisible = oldSbn != <span class="keyword">null</span> ? isVisibleToListener(oldSbn, info) : <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// This notification hasn't been and still isn't visible -&gt; ignore.</span></span><br><span class="line">        <span class="keyword">if</span> (!oldSbnVisible &amp;&amp; !sbnVisible) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the notification is hidden, don't notifyPosted listeners targeting &lt; P.</span></span><br><span class="line">        <span class="comment">// Instead, those listeners will receive notifyPosted when the notification is</span></span><br><span class="line">        <span class="comment">// unhidden.</span></span><br><span class="line">        <span class="keyword">if</span> (r.isHidden() &amp;&amp; info.targetSdkVersion &lt; Build.VERSION_CODES.P) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we shouldn't notify all listeners, this means the hidden state of</span></span><br><span class="line">        <span class="comment">// a notification was changed.  Don't notifyPosted listeners targeting &gt;= P.</span></span><br><span class="line">        <span class="comment">// Instead, those listeners will receive notifyRankingUpdate.</span></span><br><span class="line">        <span class="keyword">if</span> (!notifyAllListeners &amp;&amp; info.targetSdkVersion &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> NotificationRankingUpdate update = makeRankingUpdateLocked(info);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This notification became invisible -&gt; remove the old one.</span></span><br><span class="line">        <span class="keyword">if</span> (oldSbnVisible &amp;&amp; !sbnVisible) &#123;</span><br><span class="line">            <span class="keyword">final</span> StatusBarNotification oldSbnLightClone = oldSbn.cloneLight();</span><br><span class="line">            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    notifyRemoved(</span><br><span class="line">                            info, oldSbnLightClone, update, <span class="keyword">null</span>, REASON_USER_STOPPED);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Grant access before listener is notified</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> targetUserId = (info.userid == UserHandle.USER_ALL)</span><br><span class="line">                ? UserHandle.USER_SYSTEM : info.userid;</span><br><span class="line">        updateUriPermissions(r, old, info.component.getPackageName(), targetUserId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> StatusBarNotification sbnToPost = trimCache.ForListener(info);</span><br><span class="line">        mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                notifyPosted(info, sbnToPost, update);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6 NotificationManagerService中notifyPosted()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyPosted</span><span class="params">(<span class="keyword">final</span> ManagedServiceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> StatusBarNotification sbn, NotificationRankingUpdate rankingUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> INotificationListener listener = (INotificationListener) info.service;</span><br><span class="line">    StatusBarNotificationHolder sbnHolder = <span class="keyword">new</span> StatusBarNotificationHolder(sbn);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        listener.onNotificationPosted(sbnHolder, rankingUpdate);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"unable to notify listener (posted): "</span> + listener, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>7 NotificationListener notifyPosted</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(<span class="keyword">final</span> StatusBarNotification sbn,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> RankingMap rankingMap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"onNotificationPosted: "</span> + sbn);</span><br><span class="line">    <span class="keyword">if</span> (sbn != <span class="keyword">null</span> &amp;&amp; !onPluginNotificationPosted(sbn, rankingMap)) &#123;</span><br><span class="line">        mPresenter.getHandler().post(() -&gt; &#123;</span><br><span class="line">            processForRemoteInput(sbn.getNotification(), mContext);</span><br><span class="line">            String key = sbn.getKey();</span><br><span class="line">            mEntryManager.removeKeyKeptForRemoteInput(key);</span><br><span class="line">            <span class="keyword">boolean</span> isUpdate =</span><br><span class="line">                    mEntryManager.getNotificationData().get(key) != <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// In case we don't allow child notifications, we ignore children of</span></span><br><span class="line">            <span class="comment">// notifications that have a summary, since` we're not going to show them</span></span><br><span class="line">            <span class="comment">// anyway. This is true also when the summary is canceled,</span></span><br><span class="line">            <span class="comment">// because children are automatically canceled by NoMan in that case.</span></span><br><span class="line">            <span class="keyword">if</span> (!ENABLE_CHILD_NOTIFICATIONS</span><br><span class="line">                    &amp;&amp; mPresenter.getGroupManager().isChildInGroupWithSummary(sbn)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"Ignoring group child due to existing summary: "</span> + sbn);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Remove existing notification to avoid stale data.</span></span><br><span class="line">                <span class="keyword">if</span> (isUpdate) &#123;</span><br><span class="line">                    mEntryManager.removeNotification(key, rankingMap);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mEntryManager.getNotificationData()</span><br><span class="line">                            .updateRanking(rankingMap);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isUpdate) &#123;</span><br><span class="line">                mEntryManager.updateNotification(sbn, rankingMap);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mEntryManager.addNotification(sbn, rankingMap);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>8 NotificationEntryManager addNotification-&gt; addNotificationInternal</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addNotificationInternal</span><span class="params">(StatusBarNotification notification,</span></span></span><br><span class="line"><span class="function"><span class="params">        NotificationListenerService.RankingMap ranking)</span> <span class="keyword">throws</span> InflationException </span>&#123;</span><br><span class="line">    String key = notification.getKey();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"addNotification key="</span> + key);</span><br><span class="line"></span><br><span class="line">    mNotificationData.updateRanking(ranking);</span><br><span class="line">    NotificationData.Entry shadeEntry = createNotificationViews(notification);</span><br><span class="line">    <span class="keyword">boolean</span> isHeadsUped = shouldPeek(shadeEntry);</span><br><span class="line">    <span class="keyword">if</span> (!isHeadsUped &amp;&amp; notification.getNotification().fullScreenIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldSuppressFullScreenIntent(shadeEntry)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"No Fullscreen intent: suppressed by DND: "</span> + key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mNotificationData.getImportance(key)</span><br><span class="line">                &lt; NotificationManager.IMPORTANCE_HIGH) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"No Fullscreen intent: not important enough: "</span></span><br><span class="line">                        + key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Stop screensaver if the notification has a fullscreen intent.</span></span><br><span class="line">            <span class="comment">// (like an incoming phone call)</span></span><br><span class="line">            SystemServicesProxy.getInstance(mContext).awakenDreamsAsync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// not immersive &amp; a fullscreen alert should be shown</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG)</span><br><span class="line">                Log.d(TAG, <span class="string">"Notification has fullScreenIntent; sending fullScreenIntent"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                EventLog.writeEvent(EventLogTags.SYSUI_FULLSCREEN_NOTIFICATION,</span><br><span class="line">                        key);</span><br><span class="line">                notification.getNotification().fullScreenIntent.send();</span><br><span class="line">                shadeEntry.notifyFullScreenIntentLaunched();</span><br><span class="line">                mMetricsLogger.count(<span class="string">"note_fullscreen"</span>, <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PendingIntent.CanceledException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    abortExistingInflation(key);</span><br><span class="line"></span><br><span class="line">    mForegroundServiceController.addNotification(notification,</span><br><span class="line">            mNotificationData.getImportance(key));</span><br><span class="line"></span><br><span class="line">    mPendingNotifications.put(key, shadeEntry);</span><br><span class="line">    mGroupManager.onPendingEntryAdded(shadeEntry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9.1 createNotificationViews创建通知view</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> NotificationData.<span class="function">Entry <span class="title">createNotificationViews</span><span class="params">(StatusBarNotification sbn)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InflationException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"createNotificationViews(notification="</span> + sbn);</span><br><span class="line">    &#125;</span><br><span class="line">    NotificationData.Entry entry = <span class="keyword">new</span> NotificationData.Entry(sbn);</span><br><span class="line">    Dependency.get(LeakDetector.class).trackInstance(entry);</span><br><span class="line">    entry.createIcons(mContext, sbn);</span><br><span class="line">    <span class="comment">// Construct the expanded view.</span></span><br><span class="line">    inflateViews(entry, mListContainer.getViewParentForNotification(entry));</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inflateViews</span><span class="params">(NotificationData.Entry entry, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">    PackageManager pmUser = StatusBar.getPackageManagerForUser(mContext,</span><br><span class="line">            entry.notification.getUser().getIdentifier());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> StatusBarNotification sbn = entry.notification;</span><br><span class="line">    <span class="keyword">if</span> (entry.row != <span class="keyword">null</span>) &#123;</span><br><span class="line">        entry.reset();</span><br><span class="line">        updateNotification(entry, pmUser, sbn, entry.row);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> RowInflaterTask().inflate(mContext, parent, entry,</span><br><span class="line">                row -&gt; &#123;</span><br><span class="line">                    bindRow(entry, pmUser, sbn, row);</span><br><span class="line">                    updateNotification(entry, pmUser, sbn, row);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9.2 RowInflaterTask.inflate </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inflate</span><span class="params">(Context context, ViewGroup parent, NotificationData.Entry entry,</span></span></span><br><span class="line"><span class="function"><span class="params">                    RowInflationFinishedListener listener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (TRACE_ORIGIN) &#123;</span><br><span class="line">        mInflateOrigin = <span class="keyword">new</span> Throwable(<span class="string">"inflate requested here"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mListener = listener;</span><br><span class="line">    AsyncLayoutInflater inflater = <span class="keyword">new</span> AsyncLayoutInflater(context);</span><br><span class="line">    mEntry = entry;</span><br><span class="line">    entry.setInflationTask(<span class="keyword">this</span>);</span><br><span class="line">    inflater.inflate(R.layout.status_bar_notification_row, parent, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>9.3 view加载完成后回调updateNotification</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateNotification</span><span class="params">(NotificationData.Entry entry, PackageManager pmUser,</span></span></span><br><span class="line"><span class="function"><span class="params">        StatusBarNotification sbn, ExpandableNotificationRow row)</span> </span>&#123;</span><br><span class="line">    row.setNeedsRedaction(mLockscreenUserManager.needsRedaction(entry));</span><br><span class="line">    <span class="keyword">boolean</span> isLowPriority = mNotificationData.isAmbient(sbn.getKey());</span><br><span class="line">    <span class="keyword">boolean</span> isUpdate = mNotificationData.get(entry.key) != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> wasLowPriority = row.isLowPriority();</span><br><span class="line">    row.setIsLowPriority(isLowPriority);</span><br><span class="line">    row.setLowPriorityStateUpdated(isUpdate &amp;&amp; (wasLowPriority != isLowPriority));</span><br><span class="line">    <span class="comment">// bind the click event to the content area</span></span><br><span class="line">    mNotificationClicker.register(row, sbn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extract target SDK version.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ApplicationInfo info = pmUser.getApplicationInfo(sbn.getPackageName(), <span class="number">0</span>);</span><br><span class="line">        entry.targetSdk = info.targetSdkVersion;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Failed looking up ApplicationInfo for "</span> + sbn.getPackageName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    row.setLegacy(entry.targetSdk &gt;= Build.VERSION_CODES.GINGERBREAD</span><br><span class="line">            &amp;&amp; entry.targetSdk &lt; Build.VERSION_CODES.LOLLIPOP);</span><br><span class="line">    entry.setIconTag(R.id.icon_is_pre_L, entry.targetSdk &lt; Build.VERSION_CODES.LOLLIPOP);</span><br><span class="line">    entry.autoRedacted = entry.notification.getNotification().publicVersion == <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    entry.row = row;</span><br><span class="line">    entry.row.setOnActivatedListener(mPresenter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> useIncreasedCollapsedHeight = mMessagingUtil.isImportantMessaging(sbn,</span><br><span class="line">            mNotificationData.getImportance(sbn.getKey()));</span><br><span class="line">    <span class="keyword">boolean</span> useIncreasedHeadsUp = useIncreasedCollapsedHeight</span><br><span class="line">            &amp;&amp; !mPresenter.isPresenterFullyCollapsed();</span><br><span class="line">    row.setUseIncreasedCollapsedHeight(useIncreasedCollapsedHeight);</span><br><span class="line">    row.setUseIncreasedHeadsUpHeight(useIncreasedHeadsUp);</span><br><span class="line">    row.updateNotification(entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>10 ExpandableNotificationRow updateNotification</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateNotification</span><span class="params">(NotificationData.Entry entry)</span> </span>&#123;</span><br><span class="line">    mEntry = entry;</span><br><span class="line">    mStatusBarNotification = entry.notification;</span><br><span class="line">    mNotificationInflater.inflateNotificationViews();</span><br><span class="line">    cacheIsSystemNotification();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11 NotificationInflater inflateNotificationViews</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inflateNotificationViews</span><span class="params">(<span class="keyword">int</span> reInflateFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mRow.isRemoved()) &#123;</span><br><span class="line">        <span class="comment">// We don't want to reinflate anything for removed notifications. Otherwise views might</span></span><br><span class="line">        <span class="comment">// be readded to the stack, leading to leaks. This may happen with low-priority groups</span></span><br><span class="line">        <span class="comment">// where the removal of already removed children can lead to a reinflation.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    StatusBarNotification sbn = mRow.getEntry().notification;</span><br><span class="line">    AsyncInflationTask task = <span class="keyword">new</span> AsyncInflationTask(sbn, reInflateFlags, mRow,</span><br><span class="line">            mIsLowPriority,</span><br><span class="line">            mIsChildInGroup, mUsesIncreasedHeight, mUsesIncreasedHeadsUpHeight, mRedactAmbient,</span><br><span class="line">            mCallback, mRemoteViewClickHandler);</span><br><span class="line">    <span class="keyword">if</span> (mCallback != <span class="keyword">null</span> &amp;&amp; mCallback.doInflateSynchronous()) &#123;</span><br><span class="line">        task.onPostExecute(task.doInBackground());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        task.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12 NotificationInflater.AsyncInflationTask</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> InflationProgress <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Notification.Builder recoveredBuilder</span><br><span class="line">                = Notification.Builder.recoverBuilder(mContext,</span><br><span class="line">                mSbn.getNotification());</span><br><span class="line">        Context packageContext = mSbn.getPackageContext(mContext);</span><br><span class="line">        Notification notification = mSbn.getNotification();</span><br><span class="line">        <span class="keyword">if</span> (notification.isMediaNotification()) &#123;</span><br><span class="line">            MediaNotificationProcessor processor = <span class="keyword">new</span> MediaNotificationProcessor(mContext,</span><br><span class="line">                    packageContext);</span><br><span class="line">            processor.processNotification(notification, recoveredBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createRemoteViews(mReInflateFlags,</span><br><span class="line">                recoveredBuilder, mIsLowPriority, mIsChildInGroup,</span><br><span class="line">                mUsesIncreasedHeight, mUsesIncreasedHeadsUpHeight, mRedactAmbient,</span><br><span class="line">                packageContext);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        mError = e;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(InflationProgress result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mError == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mCancellationSignal = apply(result, mReInflateFlags, mRow, mRedactAmbient,</span><br><span class="line">                mRemoteViewClickHandler, <span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        handleError(mError);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12.1 生成RemoteView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InflationProgress <span class="title">createRemoteViews</span><span class="params">(<span class="keyword">int</span> reInflateFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        Notification.Builder builder, <span class="keyword">boolean</span> isLowPriority, <span class="keyword">boolean</span> isChildInGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> usesIncreasedHeight, <span class="keyword">boolean</span> usesIncreasedHeadsUpHeight, <span class="keyword">boolean</span> redactAmbient,</span></span></span><br><span class="line"><span class="function"><span class="params">        Context packageContext)</span> </span>&#123;</span><br><span class="line">    InflationProgress result = <span class="keyword">new</span> InflationProgress();</span><br><span class="line">    isLowPriority = isLowPriority &amp;&amp; !isChildInGroup;</span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_CONTENT_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">        result.newContentView = createContentView(builder, isLowPriority, usesIncreasedHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_EXPANDED_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">        result.newExpandedView = createExpandedView(builder, isLowPriority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_HEADS_UP_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">        result.newHeadsUpView = builder.createHeadsUpContentView(usesIncreasedHeadsUpHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_PUBLIC_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">        result.newPublicView = builder.makePublicContentView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_AMBIENT_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">        result.newAmbientView = redactAmbient ? builder.makePublicAmbientNotification()</span><br><span class="line">                : builder.makeAmbientNotification();</span><br><span class="line">    &#125;</span><br><span class="line">    result.packageContext = packageContext;</span><br><span class="line">    result.headsUpStatusBarText = builder.getHeadsUpStatusBarText(<span class="keyword">false</span> <span class="comment">/* showingPublic */</span>);</span><br><span class="line">    result.headsUpStatusBarTextPublic = builder.getHeadsUpStatusBarText(</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* showingPublic */</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>12.2 apply</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CancellationSignal <span class="title">apply</span><span class="params">(InflationProgress result, <span class="keyword">int</span> reInflateFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ExpandableNotificationRow row, <span class="keyword">boolean</span> redactAmbient,</span></span></span><br><span class="line"><span class="function"><span class="params">        RemoteViews.OnClickHandler remoteViewClickHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable InflationCallback callback)</span> </span>&#123;</span><br><span class="line">    NotificationData.Entry entry = row.getEntry();</span><br><span class="line">    NotificationContentView privateLayout = row.getPrivateLayout();</span><br><span class="line">    NotificationContentView publicLayout = row.getPublicLayout();</span><br><span class="line">    <span class="keyword">final</span> HashMap&lt;Integer, CancellationSignal&gt; runningInflations = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> flag = FLAG_REINFLATE_CONTENT_VIEW;</span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; flag) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> isNewView = !canReapplyRemoteView(result.newContentView, entry.cachedContentView);</span><br><span class="line">        ApplyCallback applyCallback = <span class="keyword">new</span> ApplyCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResultView</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                result.inflatedContentView = v;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> RemoteViews <span class="title">getRemoteView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> result.newContentView;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        applyRemoteView(result, reInflateFlags, flag, row, redactAmbient,</span><br><span class="line">                isNewView, remoteViewClickHandler, callback, entry, privateLayout,</span><br><span class="line">                privateLayout.getContractedChild(), privateLayout.getVisibleWrapper(</span><br><span class="line">                        NotificationContentView.VISIBLE_TYPE_CONTRACTED),</span><br><span class="line">                runningInflations, applyCallback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flag = FLAG_REINFLATE_EXPANDED_VIEW;</span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; flag) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.newExpandedView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> isNewView = !canReapplyRemoteView(result.newExpandedView,</span><br><span class="line">                    entry.cachedBigContentView);</span><br><span class="line">            ApplyCallback applyCallback = <span class="keyword">new</span> ApplyCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResultView</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                    result.inflatedExpandedView = v;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> RemoteViews <span class="title">getRemoteView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> result.newExpandedView;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            applyRemoteView(result, reInflateFlags, flag, row,</span><br><span class="line">                    redactAmbient, isNewView, remoteViewClickHandler, callback, entry,</span><br><span class="line">                    privateLayout, privateLayout.getExpandedChild(),</span><br><span class="line">                    privateLayout.getVisibleWrapper(</span><br><span class="line">                            NotificationContentView.VISIBLE_TYPE_EXPANDED), runningInflations,</span><br><span class="line">                    applyCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flag = FLAG_REINFLATE_HEADS_UP_VIEW;</span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; flag) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (result.newHeadsUpView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> isNewView = !canReapplyRemoteView(result.newHeadsUpView,</span><br><span class="line">                    entry.cachedHeadsUpContentView);</span><br><span class="line">            ApplyCallback applyCallback = <span class="keyword">new</span> ApplyCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResultView</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                    result.inflatedHeadsUpView = v;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> RemoteViews <span class="title">getRemoteView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> result.newHeadsUpView;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            applyRemoteView(result, reInflateFlags, flag, row,</span><br><span class="line">                    redactAmbient, isNewView, remoteViewClickHandler, callback, entry,</span><br><span class="line">                    privateLayout, privateLayout.getHeadsUpChild(),</span><br><span class="line">                    privateLayout.getVisibleWrapper(</span><br><span class="line">                            NotificationContentView.VISIBLE_TYPE_HEADSUP), runningInflations,</span><br><span class="line">                    applyCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flag = FLAG_REINFLATE_PUBLIC_VIEW;</span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; flag) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> isNewView = !canReapplyRemoteView(result.newPublicView,</span><br><span class="line">                entry.cachedPublicContentView);</span><br><span class="line">        ApplyCallback applyCallback = <span class="keyword">new</span> ApplyCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResultView</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                result.inflatedPublicView = v;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> RemoteViews <span class="title">getRemoteView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> result.newPublicView;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        applyRemoteView(result, reInflateFlags, flag, row,</span><br><span class="line">                redactAmbient, isNewView, remoteViewClickHandler, callback, entry,</span><br><span class="line">                publicLayout, publicLayout.getContractedChild(),</span><br><span class="line">                publicLayout.getVisibleWrapper(NotificationContentView.VISIBLE_TYPE_CONTRACTED),</span><br><span class="line">                runningInflations, applyCallback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flag = FLAG_REINFLATE_AMBIENT_VIEW;</span><br><span class="line">    <span class="keyword">if</span> ((reInflateFlags &amp; flag) != <span class="number">0</span>) &#123;</span><br><span class="line">        NotificationContentView newParent = redactAmbient ? publicLayout : privateLayout;</span><br><span class="line">        <span class="keyword">boolean</span> isNewView = !canReapplyAmbient(row, redactAmbient) ||</span><br><span class="line">                !canReapplyRemoteView(result.newAmbientView, entry.cachedAmbientContentView);</span><br><span class="line">        ApplyCallback applyCallback = <span class="keyword">new</span> ApplyCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResultView</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                result.inflatedAmbientView = v;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> RemoteViews <span class="title">getRemoteView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> result.newAmbientView;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        applyRemoteView(result, reInflateFlags, flag, row,</span><br><span class="line">                redactAmbient, isNewView, remoteViewClickHandler, callback, entry,</span><br><span class="line">                newParent, newParent.getAmbientChild(), newParent.getVisibleWrapper(</span><br><span class="line">                        NotificationContentView.VISIBLE_TYPE_AMBIENT), runningInflations,</span><br><span class="line">                applyCallback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Let's try to finish, maybe nobody is even inflating anything</span></span><br><span class="line">    finishIfDone(result, reInflateFlags, runningInflations, callback, row,</span><br><span class="line">            redactAmbient);</span><br><span class="line">    CancellationSignal cancellationSignal = <span class="keyword">new</span> CancellationSignal();</span><br><span class="line">    cancellationSignal.setOnCancelListener(</span><br><span class="line">            () -&gt; runningInflations.values().forEach(CancellationSignal::cancel));</span><br><span class="line">    <span class="keyword">return</span> cancellationSignal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>13 显示通知 applyRemoteView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applyRemoteView</span><span class="params">(<span class="keyword">final</span> InflationProgress result,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> reInflateFlags, <span class="keyword">int</span> inflationId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> ExpandableNotificationRow row,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">boolean</span> redactAmbient, <span class="keyword">boolean</span> isNewView,</span></span></span><br><span class="line"><span class="function"><span class="params">        RemoteViews.OnClickHandler remoteViewClickHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable <span class="keyword">final</span> InflationCallback callback, NotificationData.Entry entry,</span></span></span><br><span class="line"><span class="function"><span class="params">        NotificationContentView parentLayout, View existingView,</span></span></span><br><span class="line"><span class="function"><span class="params">        NotificationViewWrapper existingWrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> HashMap&lt;Integer, CancellationSignal&gt; runningInflations,</span></span></span><br><span class="line"><span class="function"><span class="params">        ApplyCallback applyCallback)</span> </span>&#123;</span><br><span class="line">    RemoteViews newContentView = applyCallback.getRemoteView();</span><br><span class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span> &amp;&amp; callback.doInflateSynchronous()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isNewView) &#123;</span><br><span class="line">                View v = newContentView.apply(</span><br><span class="line">                        result.packageContext,</span><br><span class="line">                        parentLayout,</span><br><span class="line">                        remoteViewClickHandler);</span><br><span class="line">                v.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">                applyCallback.setResultView(v);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                newContentView.reapply(</span><br><span class="line">                        result.packageContext,</span><br><span class="line">                        existingView,</span><br><span class="line">                        remoteViewClickHandler);</span><br><span class="line">                existingWrapper.onReinflated();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            handleInflationError(runningInflations, e, entry.notification, callback);</span><br><span class="line">            <span class="comment">// Add a running inflation to make sure we don't trigger callbacks.</span></span><br><span class="line">            <span class="comment">// Safe to do because only happens in tests.</span></span><br><span class="line">            runningInflations.put(inflationId, <span class="keyword">new</span> CancellationSignal());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    RemoteViews.OnViewAppliedListener listener</span><br><span class="line">            = <span class="keyword">new</span> RemoteViews.OnViewAppliedListener() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewApplied</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (isNewView) &#123;</span><br><span class="line">                v.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">                applyCallback.setResultView(v);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (existingWrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">                existingWrapper.onReinflated();</span><br><span class="line">            &#125;</span><br><span class="line">            runningInflations.remove(inflationId);</span><br><span class="line">            finishIfDone(result, reInflateFlags, runningInflations, callback, row,</span><br><span class="line">                    redactAmbient);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Uh oh the async inflation failed. Due to some bugs (see b/38190555), this could</span></span><br><span class="line">            <span class="comment">// actually also be a system issue, so let's try on the UI thread again to be safe.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                View newView = existingView;</span><br><span class="line">                <span class="keyword">if</span> (isNewView) &#123;</span><br><span class="line">                    newView = newContentView.apply(</span><br><span class="line">                            result.packageContext,</span><br><span class="line">                            parentLayout,</span><br><span class="line">                            remoteViewClickHandler);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    newContentView.reapply(</span><br><span class="line">                            result.packageContext,</span><br><span class="line">                            existingView,</span><br><span class="line">                            remoteViewClickHandler);</span><br><span class="line">                &#125;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"Async Inflation failed but normal inflation finished normally."</span>,</span><br><span class="line">                        e);</span><br><span class="line">                onViewApplied(newView);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception anotherException) &#123;</span><br><span class="line">                runningInflations.remove(inflationId);</span><br><span class="line">                handleInflationError(runningInflations, e, entry.notification, callback);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    CancellationSignal cancellationSignal;</span><br><span class="line">    <span class="keyword">if</span> (isNewView) &#123;</span><br><span class="line">        cancellationSignal = newContentView.applyAsync(</span><br><span class="line">                result.packageContext,</span><br><span class="line">                parentLayout,</span><br><span class="line">                EXECUTOR,</span><br><span class="line">                listener,</span><br><span class="line">                remoteViewClickHandler);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cancellationSignal = newContentView.reapplyAsync(</span><br><span class="line">                result.packageContext,</span><br><span class="line">                existingView,</span><br><span class="line">                EXECUTOR,</span><br><span class="line">                listener,</span><br><span class="line">                remoteViewClickHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    runningInflations.put(inflationId, cancellationSignal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NotificationManagerService"><a href="#NotificationManagerService" class="headerlink" title="NotificationManagerService"></a>NotificationManagerService</h2><p>消息管理中心，接收记录app系统发来的消息，并控制显示具体消息。</p>
<h2 id="RemoteViews"><a href="#RemoteViews" class="headerlink" title="RemoteViews"></a>RemoteViews</h2><p>其中Filter是用来限制和过滤View用的，判断远程view是否被RemoteView注解标注。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A class that describes a view hierarchy that can be displayed in</span></span><br><span class="line"><span class="comment"> * another process. The hierarchy is inflated from a layout resource</span></span><br><span class="line"><span class="comment"> * file, and this class provides some basic operations for modifying</span></span><br><span class="line"><span class="comment"> * the content of the inflated hierarchy.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteViews</span> <span class="keyword">implements</span> <span class="title">Parcelable</span>, <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RemoteViews只是一个实现了Parcelable和Filter接口的类，而并非继承自View。RemoteViews用来描述可运行在其他进程中的视图结构，但RemoteViews本身不是视图，只是一个描述类。RemoteViews描述的远程视图需要通过layout资源文件定义。RemoteViews类提供了一系列修改远程视图的方法。RemoteViews使用最多的场合是通知栏和桌面小插件。</p>
<h3 id="RemoteView注解"><a href="#RemoteView注解" class="headerlink" title="RemoteView注解"></a>RemoteView注解</h3><p>从注解类型来看为运行时注解，作用于类或接口，结合注释可知此注解用于View的子类，用来标识该View是否可以作为远程视图使用。只有被注解标注的控件才可以作为远程视图使用。</p>
<p>RemoteViews所支持的View类型如下：</p>
<ul>
<li>LinearLayout、RelativeLayout、FrameLayout、GridLayout、AbsoluteLayout（已弃用）</li>
<li>TextView、Button、ImageView、ImageButton、Chronometer、ProgressBar、ListView、GridView、StackView、ViewFlipper、AdapterViewFlipper、ViewStub、AnalogClock（已弃用）</li>
</ul>
<p>也就是说远程视图只能使用上述所列举的View，它们的子类及其他View都是不支持的，如果使用了不支持的View，则会报异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This annotation indicates that a subclass of View is allowed to be used</span></span><br><span class="line"><span class="comment"> * with the &#123;<span class="doctag">@link</span> RemoteViews&#125; mechanism.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123; ElementType.TYPE &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RemoteView &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RemoteViews-原理"><a href="#RemoteViews-原理" class="headerlink" title="RemoteViews 原理"></a>RemoteViews 原理</h3><p>系统将view操作封装成Action对象，Action同样实现了Parcelable接口，通过Binder传递到SystemServer进程。远程进程通过RemoteViews的apply方法来进行view的更新操作，RemoteViews的apply方法内部则会去遍历所有的action对象并调用它们的apply方法来进行view的更新操作。</p>
<p>初始化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new RemoteViews object that will display the views contained</span></span><br><span class="line"><span class="comment"> * in the specified layout file.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> packageName Name of the package that contains the layout resource</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> layoutId The id of the layout resource</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RemoteViews</span><span class="params">(String packageName, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(getApplicationInfo(packageName, UserHandle.myUserId()), layoutId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new RemoteViews object that will display the views contained</span></span><br><span class="line"><span class="comment"> * in the specified layout file.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> packageName Name of the package that contains the layout resource.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId The user under which the package is running.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> layoutId The id of the layout resource.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RemoteViews</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(getApplicationInfo(packageName, userId), layoutId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new RemoteViews object that will display the views contained</span></span><br><span class="line"><span class="comment"> * in the specified layout file.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> application The application whose content is shown by the views.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> layoutId The id of the layout resource.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">RemoteViews</span><span class="params">(ApplicationInfo application, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    mApplication = application;</span><br><span class="line">    mLayoutId = layoutId;</span><br><span class="line">    mBitmapCache = <span class="keyword">new</span> BitmapCache();</span><br><span class="line">    mClassCookies = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new RemoteViews object that will inflate as the specified</span></span><br><span class="line"><span class="comment"> * landspace or portrait RemoteViews, depending on the current configuration.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> landscape The RemoteViews to inflate in landscape configuration</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> portrait The RemoteViews to inflate in portrait configuration</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RemoteViews</span><span class="params">(RemoteViews landscape, RemoteViews portrait)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reads a RemoteViews object from a parcel.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parcel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RemoteViews</span><span class="params">(Parcel parcel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(parcel, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中最常用的就是RemoteViews(ApplicationInfo application, int layoutId)。</p>
<h3 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">apply</span><span class="params">(Context context, ViewGroup parent, OnClickHandler handler)</span> </span>&#123;</span><br><span class="line">    RemoteViews rvToApply = getRemoteViewsToApply(context);</span><br><span class="line"></span><br><span class="line">    View result = inflateView(context, rvToApply, parent);</span><br><span class="line">    loadTransitionOverride(context, handler);</span><br><span class="line"></span><br><span class="line">    rvToApply.performApply(result, parent, handler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">inflateView</span><span class="params">(Context context, RemoteViews rv, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// RemoteViews may be built by an application installed in another</span></span><br><span class="line">    <span class="comment">// user. So build a context that loads resources from that user but</span></span><br><span class="line">    <span class="comment">// still returns the current users userId so settings like data / time formats</span></span><br><span class="line">    <span class="comment">// are loaded without requiring cross user persmissions.</span></span><br><span class="line">    <span class="keyword">final</span> Context contextForResources = getContextForResources(context);</span><br><span class="line">    Context inflationContext = <span class="keyword">new</span> RemoteViewsContextWrapper(context, contextForResources);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If mApplyThemeResId is not given, Theme.DeviceDefault will be used.</span></span><br><span class="line">    <span class="keyword">if</span> (mApplyThemeResId != <span class="number">0</span>) &#123;</span><br><span class="line">        inflationContext = <span class="keyword">new</span> ContextThemeWrapper(inflationContext, mApplyThemeResId);</span><br><span class="line">    &#125;</span><br><span class="line">    LayoutInflater inflater = (LayoutInflater)</span><br><span class="line">            context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clone inflater so we load resources from correct context and</span></span><br><span class="line">    <span class="comment">// we don't add a filter to the static version returned by getSystemService.</span></span><br><span class="line">    inflater = inflater.cloneInContext(inflationContext);</span><br><span class="line">    inflater.setFilter(<span class="keyword">this</span>);</span><br><span class="line">    View v = inflater.inflate(rv.getLayoutId(), parent, <span class="keyword">false</span>);</span><br><span class="line">    v.setTagInternal(R.id.widget_frame, rv.getLayoutId());</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过action实现跨进程加载更新UI操作</span></span><br><span class="line"><span class="comment">// 遍历RemoteViews中存储的Action，然后执行Action的apply方法</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performApply</span><span class="params">(View v, ViewGroup parent, OnClickHandler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mActions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handler = handler == <span class="keyword">null</span> ? DEFAULT_ON_CLICK_HANDLER : handler;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = mActions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            Action a = mActions.get(i);</span><br><span class="line">            a.apply(v, parent, handler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3><p>从说明来看，Action就是对远程视图操作的一个封装，它提供了一个抽象方法。Action有很多子类，几乎每个子类都用来辅助一种View操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class for all actions that can be performed on an</span></span><br><span class="line"><span class="comment"> * inflated view.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  SUBCLASSES MUST BE IMMUTABLE SO CLONE WORKS!!!!!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Action</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(View root, ViewGroup rootParent,</span></span></span><br><span class="line"><span class="function"><span class="params">            OnClickHandler handler)</span> <span class="keyword">throws</span> ActionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MERGE_REPLACE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MERGE_APPEND = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MERGE_IGNORE = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBitmapCache</span><span class="params">(BitmapCache bitmapCache)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">mergeBehavior</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MERGE_REPLACE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getActionTag</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUniqueKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (getActionTag() + <span class="string">"_"</span> + viewId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is called on the background thread. It should perform any non-ui computations</span></span><br><span class="line"><span class="comment">     * and return the final action which will run on the UI thread.</span></span><br><span class="line"><span class="comment">     * Override this if some of the tasks can be performed async.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Action <span class="title">initActionAsync</span><span class="params">(ViewTree root, ViewGroup rootParent, OnClickHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">prefersAsyncApply</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Overridden by subclasses which have (or inherit) an ApplicationInfo instance</span></span><br><span class="line"><span class="comment">     * as member variable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasSameAppInfo</span><span class="params">(ApplicationInfo parentInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitUris</span><span class="params">(@NonNull Consumer&lt;Uri&gt; visitor)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Nothing to visit by default</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">int</span> viewId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义了很多action去实现view的操作</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewPaddingAction</span> <span class="keyword">extends</span> <span class="title">Action</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TextViewSizeAction</span> <span class="keyword">extends</span> <span class="title">Action</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="设置textview文本为例"><a href="#设置textview文本为例" class="headerlink" title="设置textview文本为例"></a>设置textview文本为例</h3><p>可以看到第二个参数为方法名，此时应该可以想到后面会使用反射来为TextView赋值了。接着可以看到果然将对TextView的操作封装成了一个Action，这里的实现子类为ReflectionAction，并将其添加到mActions列表中，需要注意的是此时并未立即执行该View操作，只是添加到了操作列表。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Equivalent to calling &#123;<span class="doctag">@link</span> TextView#setText(CharSequence)&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> viewId The id of the view whose text should change</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text The new text for the view</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextViewText</span><span class="params">(<span class="keyword">int</span> viewId, CharSequence text)</span> </span>&#123;</span><br><span class="line">    setCharSequence(viewId, <span class="string">"setText"</span>, text);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Call a method taking one CharSequence on a view in the layout for this RemoteViews.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> viewId The id of the view on which to call the method.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> methodName The name of the method to call.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value The value to pass to the method.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCharSequence</span><span class="params">(<span class="keyword">int</span> viewId, String methodName, CharSequence value)</span> </span>&#123;</span><br><span class="line">    addAction(<span class="keyword">new</span> ReflectionAction(viewId, methodName, ReflectionAction.CHAR_SEQUENCE, value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ReflectionAction.apply,通过反射找到对应的view和方法，并调用方法。对于自定义通知栏，需要NotificationManager调用notify()之后；而对于桌面小部件，则需要AppWidgetManager调用updateAppWidget()之后。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(View root, ViewGroup rootParent, OnClickHandler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> View view = root.findViewById(viewId);</span><br><span class="line">    <span class="keyword">if</span> (view == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; param = getParameterType();</span><br><span class="line">    <span class="keyword">if</span> (param == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ActionException(<span class="string">"bad type: "</span> + <span class="keyword">this</span>.type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getMethod(view, <span class="keyword">this</span>.methodName, param, <span class="keyword">false</span> <span class="comment">/* async */</span>).invoke(view, <span class="keyword">this</span>.value);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ActionException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>在自定义RemoteViews的时候，在更新UI时候尽量不要复用RemoteViews，因为每次更新操作都会在RemoteViews的mActions里面添加一个Action，这个list只增不减，会导致binder传输信息太大的异常信息。</p>

</article>

    <div class="pagenator post-pagenator">
    
    
        <a class="extend prev post-prev" href="/2018/12/29/PMS /">前の章</a>
    

    
    <p>前回の更新 2018-12-21</p>
    
    
        <a class="extend next post-next" href="/2018/12/19/SP详解/">次の章</a>
    
    </div>

    </div>
    <div class="footer">
        <div class="container">
    <div class="social">
	<ul class="social-list">
		
			
				
				
				<li>
					<a href="mailto:shenyonghe525@gmail.com" title="email" target="_blank">
					<i class="fa fa-email"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
				
				<li>
					<a href="https://github.com/sirencode" title="github" target="_self">
					<i class="fa fa-github"></i>
					</a>
				</li>
			
		
			
		
			
		
			
		
			
		
			
		
			
		
	</ul>
</div>
    <div class="copyright">
        <span>
            
            
            
                © ShenYonghe 2016 - 2019
            
        </span>
    </div>
    <div class="power">
        <span>
            Powered by <a href="https://hexo.io">Hexo</a> & <a href="https://github.com/CaiChenghan/iLiKE">iLiKE Theme</a>
        </span>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <!--page counter part-->
<script>
function addCount (Counter) {
    url=$('.article-date').attr('href').trim();
    title = $('.article-title').text().trim();
    var query = new AV.Query(Counter);
    //use url as unique idnetfication
    query.equalTo("url",url);
    query.find({
        success: function(results) {
            if (results.length>0) {
                var counter=results[0];
                counter.fetchWhenSave(true); //get recent result
                counter.increment("time");
                counter.save();
            } else {
                var newcounter=new Counter();
                newcounter.set("title",title);
                newcounter.set("url",url);
                newcounter.set("time",1);
                newcounter.save(null,{
                    success: function(newcounter) {
                        //alert('New object created');
                    }, error: function(newcounter,error) {
                        alert('Failed to create');
                    }
                })
            }
        },
        error: function(error) {
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function() {
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1) {
       addCount(Counter);
    }
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10); 
    query.find({
        success: function(results) {
                for(var i=0;i<results.length;i++) {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error) {
            alert("Error:"+error.code+" "+error.message);
        }
    });
});
</script>
</div>
    </div>
</body>
</html>
